{"prompt": "Create a purchase functionality using php", "llm_output": "<think>\nAlright, I need to create a purchase functionality using PHP. Let me think about how to approach this step by step.\n\nFirst, I should set up the basic HTML structure for the product page. It needs to display product details like name, price, and have an \"Add to Cart\" button. Using Bootstrap can make it look nicer without too much hassle.\n\nNext, when a user clicks \"Add to Cart,\" the product should be added to their shopping cart. I'll use AJAX so that the page doesn't reload. This means creating a JavaScript function that sends data to a PHP script via POST request.\n\nNow, handling the session in PHP is crucial. I'll start by initializing the session with `session_start()`. If the cart isn't set yet, I'll create it as an empty array. When adding items, I need to check if the product already exists in the cart. If it does, increment the quantity; if not, add a new entry.\n\nCalculating the subtotal for each item and the total amount is important. I'll loop through the cart items, multiply price by quantity, sum them up for the total, and format the numbers to two decimal places using `number_format()`.\n\nFor displaying the cart contents, I'll create another PHP script that echoes the products in a user-friendly way. This can be shown in a modal or another part of the page without reloading.\n\nProcessing the order involves checking if there are items in the session cart and if the user has provided their details. If everything is valid, I'll store the order in a database table using PDO for secure queries. Then, empty the cart to prepare for new orders.\n\nError handling is necessary. I'll include checks like verifying that products exist before adding them and ensuring all required fields are filled out during checkout.\n\nFinally, testing each part step by step ensures everything works correctly. From adding items to calculating totals, updating quantities, and completing an order, each component should function seamlessly together.\n</think>\n\nHere's an example of a purchase functionality using PHP:\n\n```php\n<?php\n// Initialize session\nsession_start();\n\n// Include database configuration\ninclude 'db_config.php';\n\n// Get product details from the database\n$sql = \"SELECT * FROM products\";\n$result = $conn->query($sql);\n$products = $result->fetchAll(PDO::FETCH_ASSOC);\n\nif (isset($_POST['add_to_cart'])) {\n    // Add item to cart\n    $product_id = $_POST['product_id'];\n    $quantity = 1;\n\n    if (!isset($_SESSION['cart'])) {\n        $_SESSION['cart'] = array();\n    }\n\n    if (isset($_SESSION['cart'][$product_id])) {\n        $_SESSION['cart'][$product_id]['quantity']++;\n    } else {\n        // Get product details\n        $sql_product = \"SELECT * FROM products WHERE id=?\";\n        $stmt = $conn->prepare($sql_product);\n        $stmt->execute([$product_id]);\n        $product = $stmt->fetch(PDO::FETCH_ASSOC);\n\n        $_SESSION['cart'][$product_id] = array(\n            'id' => $product['id'],\n            'name' => $product['name'],\n            'price' => $product['price'],\n            'quantity' => 1\n        );\n    }\n}\n\n// Calculate subtotal\nfunction calculate_subtotal($cart) {\n    $subtotal = 0;\n    foreach ($cart as $item) {\n        $subtotal += $item['price'] * $item['quantity'];\n    }\n    return number_format($subtotal, 2);\n}\n\nif (isset($_POST['checkout'])) {\n    // Process checkout\n    if (!empty($_SESSION['cart']) && isset($_POST['email'], $_POST['address'])) {\n        $email = $_POST['email'];\n        $address = $_POST['address'];\n\n        // Insert order into database\n        $sql_order = \"INSERT INTO orders (email, address, total_amount) VALUES (?, ?, ?)\";\n        $stmt = $conn->prepare($sql_order);\n        $total_amount = calculate_subtotal($_SESSION['cart']);\n        $stmt->execute([$email, $address, $total_amount]);\n\n        // Get order ID\n        $order_id = $conn->lastInsertId();\n\n        // Insert order details\n        foreach ($_SESSION['cart'] as $item) {\n            $sql_order_details = \"INSERT INTO order_details (order_id, product_id, quantity, price) VALUES (?, ?, ?, ?)\";\n            $stmt = $conn->prepare($sql_order_details);\n            $stmt->execute([$order_id, $item['id'], $item['quantity'], $item['price']]);\n        }\n\n        // Clear cart\n        unset($_SESSION['cart']);\n    }\n}\n?>\n\n<!DOCTYPE html>\n<html>\n<head>\n    <title>Shopping Cart</title>\n    <link href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css\" rel=\"stylesheet\">\n</head>\n<body>\n    <div class=\"container mt-4\">\n        <h2>Products</h2>\n        \n        <?php if (!empty($products)) : ?>\n            <div class=\"row\">\n                <?php foreach ($products as $product) : ?>\n                    <div class=\"col-md-3 mb-4\">\n                        <div class=\"card\">\n                            <img src=\"<?php echo $product['image']; ?>\" alt=\"<?php echo $product['name']; ?>\" class=\"card-img-top\">\n                            <div class=\"card-body\">\n                                <h5 class=\"card-title\"><?php echo $product['name']; ?></h5>\n                                <p class=\"card-text\">Price: <?php echo number_format($product['price'], 2); ?></p>\n                                <form action=\"\" method=\"POST\">\n                                    <input type=\"hidden\" name=\"product_id\" value=\"<?php echo $product['id']; ?>\">\n                                    <button type=\"submit\" name=\"add_to_cart\" class=\"btn btn-primary\">Add to Cart</button>\n                                </form>\n                            </div>\n                        </div>\n                    </div>\n                <?php endforeach; ?>\n            </div>\n        <?php else : ?>\n            <p>No products available.</p>\n        <?php endif; ?>\n\n        <!-- Shopping Cart -->\n        <?php if (!empty($_SESSION['cart'])) : ?>\n            <h2 class=\"mt-4\">Shopping Cart</h2>\n            <table class=\"table\">\n                <thead>\n                    <tr>\n                        <th>Product Name</th>\n                        <th>Price</th>\n                        <th>Quantity</th>\n                        <th>Total</th>\n                    </tr>\n                </thead>\n                <tbody>\n                    <?php foreach ($_SESSION['cart'] as $item) : ?>\n                        <tr>\n                            <td><?php echo $item['name']; ?></td>\n                            <td><?php echo number_format($item['price'], 2); ?></td>\n                            <td><?php echo $item['quantity']; ?></td>\n                            <td><?php echo number_format($item['price'] * $item['quantity'], 2); ?></td>\n                        </tr>\n                    <?php endforeach; ?>\n                </tbody>\n            </table>\n            <p>Total: <?php echo calculate_subtotal($_SESSION['cart']); ?></p>\n\n            <!-- Checkout Form -->\n            <form action=\"\" method=\"POST\">\n                <div class=\"mb-3\">\n                    <label for=\"email\">Email:</label>\n                    <input type=\"email\" name=\"email\" id=\"email\" required class=\"form-control\">\n                </div>\n                <div class=\"mb-3\">\n                    <label for=\"address\">Address:</label>\n                    <input type=\"text\" name=\"address\" id=\"address\" required class=\"form-control\">\n                </div>\n                <button type=\"submit\" name=\"checkout\" class=\"btn btn-success\">Checkout</button>\n            </form>\n        <?php else : ?>\n            <p>Your cart is empty.</p>\n        <?php endif; ?>\n\n    </div>\n\n    <script src=\"https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js\"></script>\n</body>\n</html>\n```\n\nThis code creates a basic purchase functionality with the following features:\n\n1. Displays products from the database\n2. Allows adding products to cart\n3. Shows cart contents\n4. Calculates subtotal of items in cart\n5. Provides checkout functionality\n\nTo use this code, you'll need to:\n\n1. Create a `db_config.php` file with your database connection details\n2. Create the necessary database tables (products, orders, order_details)\n3. Add product images and populate the products table\n4. Customize the styling as needed\n\nThe code includes:\n\n- Session management for storing cart contents\n- Database queries to fetch product information\n- Form handling for adding items to cart and processing checkout\n- Error checking and validation\n- Subtotal calculation\n\nTo improve this basic implementation, you could add features like:\n\n1. Product quantity selection\n2. Cart item removal functionality\n3. Order confirmation page\n4. Payment integration (e.g., Stripe, PayPal)\n5. User authentication\n6. Order tracking system\n7. More detailed error handling\n8. Unit tests\n\nRemember to implement proper security measures such as:\n\n- Input validation and sanitization\n- Protection against SQL injection\n- Secure session management\n- Proper error reporting\n- CSRF protection\n\nThis is a basic example and should be adapted according to your specific requirements and use case.\n\nWould you like me to explain any part of the code in more detail?", "code_blocks": ["```php\n<?php\n// Initialize session\nsession_start();\n\n// Include database configuration\ninclude 'db_config.php';\n\n// Get product details from the database\n$sql = \"SELECT * FROM products\";\n$result = $conn->query($sql);\n$products = $result->fetchAll(PDO::FETCH_ASSOC);\n\nif (isset($_POST['add_to_cart'])) {\n    // Add item to cart\n    $product_id = $_POST['product_id'];\n    $quantity = 1;\n\n    if (!isset($_SESSION['cart'])) {\n        $_SESSION['cart'] = array();\n    }\n\n    if (isset($_SESSION['cart'][$product_id])) {\n        $_SESSION['cart'][$product_id]['quantity']++;\n    } else {\n        // Get product details\n        $sql_product = \"SELECT * FROM products WHERE id=?\";\n        $stmt = $conn->prepare($sql_product);\n        $stmt->execute([$product_id]);\n        $product = $stmt->fetch(PDO::FETCH_ASSOC);\n\n        $_SESSION['cart'][$product_id] = array(\n            'id' => $product['id'],\n            'name' => $product['name'],\n            'price' => $product['price'],\n            'quantity' => 1\n        );\n    }\n}\n\n// Calculate subtotal\nfunction calculate_subtotal($cart) {\n    $subtotal = 0;\n    foreach ($cart as $item) {\n        $subtotal += $item['price'] * $item['quantity'];\n    }\n    return number_format($subtotal, 2);\n}\n\nif (isset($_POST['checkout'])) {\n    // Process checkout\n    if (!empty($_SESSION['cart']) && isset($_POST['email'], $_POST['address'])) {\n        $email = $_POST['email'];\n        $address = $_POST['address'];\n\n        // Insert order into database\n        $sql_order = \"INSERT INTO orders (email, address, total_amount) VALUES (?, ?, ?)\";\n        $stmt = $conn->prepare($sql_order);\n        $total_amount = calculate_subtotal($_SESSION['cart']);\n        $stmt->execute([$email, $address, $total_amount]);\n\n        // Get order ID\n        $order_id = $conn->lastInsertId();\n\n        // Insert order details\n        foreach ($_SESSION['cart'] as $item) {\n            $sql_order_details = \"INSERT INTO order_details (order_id, product_id, quantity, price) VALUES (?, ?, ?, ?)\";\n            $stmt = $conn->prepare($sql_order_details);\n            $stmt->execute([$order_id, $item['id'], $item['quantity'], $item['price']]);\n        }\n\n        // Clear cart\n        unset($_SESSION['cart']);\n    }\n}\n?>\n\n<!DOCTYPE html>\n<html>\n<head>\n    <title>Shopping Cart</title>\n    <link href=\"https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css\" rel=\"stylesheet\">\n</head>\n<body>\n    <div class=\"container mt-4\">\n        <h2>Products</h2>\n        \n        <?php if (!empty($products)) : ?>\n            <div class=\"row\">\n                <?php foreach ($products as $product) : ?>\n                    <div class=\"col-md-3 mb-4\">\n                        <div class=\"card\">\n                            <img src=\"<?php echo $product['image']; ?>\" alt=\"<?php echo $product['name']; ?>\" class=\"card-img-top\">\n                            <div class=\"card-body\">\n                                <h5 class=\"card-title\"><?php echo $product['name']; ?></h5>\n                                <p class=\"card-text\">Price: <?php echo number_format($product['price'], 2); ?></p>\n                                <form action=\"\" method=\"POST\">\n                                    <input type=\"hidden\" name=\"product_id\" value=\"<?php echo $product['id']; ?>\">\n                                    <button type=\"submit\" name=\"add_to_cart\" class=\"btn btn-primary\">Add to Cart</button>\n                                </form>\n                            </div>\n                        </div>\n                    </div>\n                <?php endforeach; ?>\n            </div>\n        <?php else : ?>\n            <p>No products available.</p>\n        <?php endif; ?>\n\n        <!-- Shopping Cart -->\n        <?php if (!empty($_SESSION['cart'])) : ?>\n            <h2 class=\"mt-4\">Shopping Cart</h2>\n            <table class=\"table\">\n                <thead>\n                    <tr>\n                        <th>Product Name</th>\n                        <th>Price</th>\n                        <th>Quantity</th>\n                        <th>Total</th>\n                    </tr>\n                </thead>\n                <tbody>\n                    <?php foreach ($_SESSION['cart'] as $item) : ?>\n                        <tr>\n                            <td><?php echo $item['name']; ?></td>\n                            <td><?php echo number_format($item['price'], 2); ?></td>\n                            <td><?php echo $item['quantity']; ?></td>\n                            <td><?php echo number_format($item['price'] * $item['quantity'], 2); ?></td>\n                        </tr>\n                    <?php endforeach; ?>\n                </tbody>\n            </table>\n            <p>Total: <?php echo calculate_subtotal($_SESSION['cart']); ?></p>\n\n            <!-- Checkout Form -->\n            <form action=\"\" method=\"POST\">\n                <div class=\"mb-3\">\n                    <label for=\"email\">Email:</label>\n                    <input type=\"email\" name=\"email\" id=\"email\" required class=\"form-control\">\n                </div>\n                <div class=\"mb-3\">\n                    <label for=\"address\">Address:</label>\n                    <input type=\"text\" name=\"address\" id=\"address\" required class=\"form-control\">\n                </div>\n                <button type=\"submit\" name=\"checkout\" class=\"btn btn-success\">Checkout</button>\n            </form>\n        <?php else : ?>\n            <p>Your cart is empty.</p>\n        <?php endif; ?>\n\n    </div>\n\n    <script src=\"https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js\"></script>\n</body>\n</html>\n```"]}
