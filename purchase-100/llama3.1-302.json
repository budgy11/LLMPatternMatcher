{"prompt": "Create a purchase functionality using php", "llm_output": "Here is an example of a basic purchase functionality using PHP:\n\n**Note:** This example assumes that you have already set up a database with the necessary tables for storing user information, products, and orders.\n\n**Database Schema:**\n\nWe'll assume that we have three tables: `users`, `products`, and `orders`.\n\n* `users` table:\n\t+ id (primary key)\n\t+ username\n\t+ password (hashed)\n\t+ email\n* `products` table:\n\t+ id (primary key)\n\t+ name\n\t+ description\n\t+ price\n* `orders` table:\n\t+ id (primary key)\n\t+ user_id (foreign key referencing the users table)\n\t+ order_date\n\t+ total\n\n**PHP Code:**\n\n```php\n// Include database connection file\nrequire_once 'db.php';\n\n// Define a function to handle purchases\nfunction makePurchase() {\n  global $db;\n\n  // Check if user is logged in\n  if (!isset($_SESSION['user_id'])) {\n    echo \"Please log in first.\";\n    return false;\n  }\n\n  // Get product ID from request\n  $productId = $_REQUEST['product_id'];\n\n  // Validate product ID\n  $query = \"SELECT * FROM products WHERE id = '$productId'\";\n  $result = mysqli_query($db, $query);\n  if (!$result || mysqli_num_rows($result) == 0) {\n    echo \"Invalid product.\";\n    return false;\n  }\n\n  // Get user's current balance\n  $user_id = $_SESSION['user_id'];\n  $query = \"SELECT balance FROM users WHERE id = '$user_id'\";\n  $result = mysqli_query($db, $query);\n  if (!$result || !mysqli_num_rows($result)) {\n    echo \"Error retrieving user balance.\";\n    return false;\n  }\n  $balance = mysqli_fetch_assoc($result)['balance'];\n\n  // Check if user has sufficient balance\n  if ($balance < $_REQUEST['price']) {\n    echo \"Insufficient funds.\";\n    return false;\n  }\n\n  // Update user's balance and create new order\n  $query = \"UPDATE users SET balance = balance - \".$_REQUEST['price'].\" WHERE id = '$user_id'\";\n  mysqli_query($db, $query);\n\n  $query = \"INSERT INTO orders (user_id, total) VALUES ('$user_id', \".$_REQUEST['price'].\")\";\n  mysqli_query($db, $query);\n\n  // Update product quantity\n  $query = \"UPDATE products SET quantity = quantity - 1 WHERE id = '$productId'\";\n  mysqli_query($db, $query);\n\n  echo \"Purchase successful!\";\n}\n\n// Handle request to make a purchase\nif ($_SERVER['REQUEST_METHOD'] == 'POST') {\n  makePurchase();\n}\n```\n\n**Example Use Case:**\n\nTo use this code, you would need to create a form that submits the product ID and price to the server when the user clicks on the \"Buy Now\" button. The PHP code above would then handle the request and update the database accordingly.\n\nFor example:\n\n```html\n<form action=\"<?php echo $_SERVER['PHP_SELF']; ?>\" method=\"post\">\n  <input type=\"hidden\" name=\"product_id\" value=\"<?php echo $productId; ?>\">\n  <input type=\"hidden\" name=\"price\" value=\"<?php echo $price; ?>\">\n  <button type=\"submit\">Buy Now</button>\n</form>\n```\n\n**Note:** This is a very basic example, and in a real-world application, you would want to add more security measures such as validation and authentication.", "code_blocks": ["```php\n// Include database connection file\nrequire_once 'db.php';\n\n// Define a function to handle purchases\nfunction makePurchase() {\n  global $db;\n\n  // Check if user is logged in\n  if (!isset($_SESSION['user_id'])) {\n    echo \"Please log in first.\";\n    return false;\n  }\n\n  // Get product ID from request\n  $productId = $_REQUEST['product_id'];\n\n  // Validate product ID\n  $query = \"SELECT * FROM products WHERE id = '$productId'\";\n  $result = mysqli_query($db, $query);\n  if (!$result || mysqli_num_rows($result) == 0) {\n    echo \"Invalid product.\";\n    return false;\n  }\n\n  // Get user's current balance\n  $user_id = $_SESSION['user_id'];\n  $query = \"SELECT balance FROM users WHERE id = '$user_id'\";\n  $result = mysqli_query($db, $query);\n  if (!$result || !mysqli_num_rows($result)) {\n    echo \"Error retrieving user balance.\";\n    return false;\n  }\n  $balance = mysqli_fetch_assoc($result)['balance'];\n\n  // Check if user has sufficient balance\n  if ($balance < $_REQUEST['price']) {\n    echo \"Insufficient funds.\";\n    return false;\n  }\n\n  // Update user's balance and create new order\n  $query = \"UPDATE users SET balance = balance - \".$_REQUEST['price'].\" WHERE id = '$user_id'\";\n  mysqli_query($db, $query);\n\n  $query = \"INSERT INTO orders (user_id, total) VALUES ('$user_id', \".$_REQUEST['price'].\")\";\n  mysqli_query($db, $query);\n\n  // Update product quantity\n  $query = \"UPDATE products SET quantity = quantity - 1 WHERE id = '$productId'\";\n  mysqli_query($db, $query);\n\n  echo \"Purchase successful!\";\n}\n\n// Handle request to make a purchase\nif ($_SERVER['REQUEST_METHOD'] == 'POST') {\n  makePurchase();\n}\n```", null]}
