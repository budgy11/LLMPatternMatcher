{"prompt": "Create a purchase functionality using php", "llm_output": "Here is an example of a simple purchase functionality in PHP. This example will include user authentication, product selection, and payment processing.\n\n**Database Schema**\n\nWe'll assume that we have the following database tables:\n\n```sql\nCREATE TABLE users (\n  id INT PRIMARY KEY AUTO_INCREMENT,\n  name VARCHAR(255),\n  email VARCHAR(255)\n);\n\nCREATE TABLE products (\n  id INT PRIMARY KEY AUTO_INCREMENT,\n  name VARCHAR(255),\n  price DECIMAL(10,2)\n);\n\nCREATE TABLE orders (\n  id INT PRIMARY KEY AUTO_INCREMENT,\n  user_id INT,\n  product_id INT,\n  total DECIMAL(10,2),\n  FOREIGN KEY (user_id) REFERENCES users(id),\n  FOREIGN KEY (product_id) REFERENCES products(id)\n);\n```\n\n**PHP Code**\n\n```php\n<?php\n\n// Config file for database connection and other settings\nrequire_once 'config.php';\n\n// Function to authenticate user\nfunction authenticateUser($email, $password) {\n  global $conn;\n  $query = \"SELECT * FROM users WHERE email = '$email' AND password = '$password'\";\n  $result = mysqli_query($conn, $query);\n  if (mysqli_num_rows($result) > 0) {\n    return true;\n  } else {\n    return false;\n  }\n}\n\n// Function to add product to cart\nfunction addProductToCart($userId, $productId) {\n  global $conn;\n  $query = \"INSERT INTO orders (user_id, product_id) VALUES ('$userId', '$productId')\";\n  mysqli_query($conn, $query);\n}\n\n// Function to remove product from cart\nfunction removeProductFromCart($orderId) {\n  global $conn;\n  $query = \"DELETE FROM orders WHERE id = '$orderId'\";\n  mysqli_query($conn, $query);\n}\n\n// Function to update order total\nfunction updateOrderTotal($orderId, $newTotal) {\n  global $conn;\n  $query = \"UPDATE orders SET total = '$newTotal' WHERE id = '$orderId'\";\n  mysqli_query($conn, $query);\n}\n\n// Function to complete purchase\nfunction completePurchase($userId) {\n  global $conn;\n  $query = \"SELECT * FROM orders WHERE user_id = '$userId' AND status = 'pending'\";\n  $result = mysqli_query($conn, $query);\n  if (mysqli_num_rows($result) > 0) {\n    while ($row = mysqli_fetch_assoc($result)) {\n      $productId = $row['product_id'];\n      $total = $row['total'];\n      // Update product stock\n      $query = \"UPDATE products SET stock = stock - 1 WHERE id = '$productId'\";\n      mysqli_query($conn, $query);\n      // Update order status\n      $query = \"UPDATE orders SET status = 'completed' WHERE id = '$row[id]'\";\n      mysqli_query($conn, $query);\n    }\n  }\n}\n\n// Function to process payment\nfunction processPayment($orderId) {\n  global $conn;\n  $query = \"SELECT * FROM orders WHERE id = '$orderId'\";\n  $result = mysqli_query($conn, $query);\n  if (mysqli_num_rows($result) > 0) {\n    $row = mysqli_fetch_assoc($result);\n    // Process payment using a payment gateway\n    // For example, using Stripe API\n    $amount = $row['total'];\n    $currency = 'USD';\n    $paymentMethod = 'card'; // Replace with actual payment method\n    try {\n      \\Stripe\\Stripe::setApiKey('YOUR_STRIPE_SECRET_KEY');\n      $charge = \\Stripe\\Charge::create(array(\n        'amount' => $amount,\n        'currency' => $currency,\n        'source' => $paymentMethod, // Replace with actual payment method\n        'description' => 'Purchase'\n      ));\n      if ($charge['status'] == 'succeeded') {\n        updateOrderTotal($orderId, $amount);\n      } else {\n        throw new Exception('Payment failed');\n      }\n    } catch (Exception $e) {\n      echo \"Error processing payment: \" . $e->getMessage();\n    }\n  }\n}\n\n// Example usage\nif ($_SERVER['REQUEST_METHOD'] == 'POST') {\n  if (isset($_POST['login'])) {\n    // Login user\n    $email = $_POST['email'];\n    $password = $_POST['password'];\n    if (authenticateUser($email, $password)) {\n      echo \"Logged in successfully\";\n    } else {\n      echo \"Invalid email or password\";\n    }\n  } elseif (isset($_POST['addToCart'])) {\n    // Add product to cart\n    $userId = $_SESSION['user_id']; // Replace with actual user ID\n    $productId = $_POST['product_id'];\n    addProductToCart($userId, $productId);\n  } elseif (isset($_POST['removeFromCart'])) {\n    // Remove product from cart\n    $orderId = $_POST['order_id'];\n    removeProductFromCart($orderId);\n  } elseif (isset($_POST['completePurchase'])) {\n    // Complete purchase\n    $userId = $_SESSION['user_id']; // Replace with actual user ID\n    completePurchase($userId);\n  }\n}\n\n?>\n```\n\n**HTML Code**\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n  <title>Purchase Functionality</title>\n</head>\n<body>\n  <?php if (isset($_SESSION['user_id'])) : ?>\n    <!-- User is logged in -->\n    <h1>Welcome, <?= $_SESSION['name'] ?>!</h1>\n    <form action=\"\" method=\"post\">\n      <input type=\"hidden\" name=\"addToCart\" value=\"true\">\n      <select name=\"product_id\">\n        <?php foreach ($products as $product) : ?>\n          <option value=\"<?= $product['id'] ?>\">\n            <?= $product['name'] ?> - $<?= $product['price'] ?>\n          </option>\n        <?php endforeach; ?>\n      </select>\n      <button type=\"submit\">Add to Cart</button>\n    </form>\n  <?php else : ?>\n    <!-- User is not logged in -->\n    <h1>Login or register to add products to your cart!</h1>\n    <form action=\"\" method=\"post\">\n      <input type=\"text\" name=\"email\" placeholder=\"Email\">\n      <input type=\"password\" name=\"password\" placeholder=\"Password\">\n      <button type=\"submit\" name=\"login\">Login</button>\n    </form>\n  <?php endif; ?>\n  \n  <?php if (isset($_SESSION['user_id'])) : ?>\n    <!-- User is logged in -->\n    <h1>Cart:</h1>\n    <ul>\n      <?php foreach ($orders as $order) : ?>\n        <li><?= $order['product_name'] ?> - $<?= $order['total'] ?></li>\n      <?php endforeach; ?>\n    </ul>\n  <?php endif; ?>\n  \n  <?php if (isset($_SESSION['user_id'])) : ?>\n    <!-- User is logged in -->\n    <h1>Checkout:</h1>\n    <form action=\"\" method=\"post\">\n      <input type=\"hidden\" name=\"completePurchase\" value=\"true\">\n      <button type=\"submit\">Complete Purchase</button>\n    </form>\n  <?php endif; ?>\n</body>\n</html>\n```\n\n**Note:**\n\n* This is a simplified example and you should adjust the code to fit your specific needs.\n* You should use prepared statements to prevent SQL injection attacks.\n* You should use HTTPS (SSL/TLS) for secure communication between client and server.\n* You should validate user input to prevent errors.\n* You should handle exceptions and errors properly.\n\nThis is just a basic example of how you can implement purchase functionality using PHP.", "code_blocks": [null, "```php\n<?php\n\n// Config file for database connection and other settings\nrequire_once 'config.php';\n\n// Function to authenticate user\nfunction authenticateUser($email, $password) {\n  global $conn;\n  $query = \"SELECT * FROM users WHERE email = '$email' AND password = '$password'\";\n  $result = mysqli_query($conn, $query);\n  if (mysqli_num_rows($result) > 0) {\n    return true;\n  } else {\n    return false;\n  }\n}\n\n// Function to add product to cart\nfunction addProductToCart($userId, $productId) {\n  global $conn;\n  $query = \"INSERT INTO orders (user_id, product_id) VALUES ('$userId', '$productId')\";\n  mysqli_query($conn, $query);\n}\n\n// Function to remove product from cart\nfunction removeProductFromCart($orderId) {\n  global $conn;\n  $query = \"DELETE FROM orders WHERE id = '$orderId'\";\n  mysqli_query($conn, $query);\n}\n\n// Function to update order total\nfunction updateOrderTotal($orderId, $newTotal) {\n  global $conn;\n  $query = \"UPDATE orders SET total = '$newTotal' WHERE id = '$orderId'\";\n  mysqli_query($conn, $query);\n}\n\n// Function to complete purchase\nfunction completePurchase($userId) {\n  global $conn;\n  $query = \"SELECT * FROM orders WHERE user_id = '$userId' AND status = 'pending'\";\n  $result = mysqli_query($conn, $query);\n  if (mysqli_num_rows($result) > 0) {\n    while ($row = mysqli_fetch_assoc($result)) {\n      $productId = $row['product_id'];\n      $total = $row['total'];\n      // Update product stock\n      $query = \"UPDATE products SET stock = stock - 1 WHERE id = '$productId'\";\n      mysqli_query($conn, $query);\n      // Update order status\n      $query = \"UPDATE orders SET status = 'completed' WHERE id = '$row[id]'\";\n      mysqli_query($conn, $query);\n    }\n  }\n}\n\n// Function to process payment\nfunction processPayment($orderId) {\n  global $conn;\n  $query = \"SELECT * FROM orders WHERE id = '$orderId'\";\n  $result = mysqli_query($conn, $query);\n  if (mysqli_num_rows($result) > 0) {\n    $row = mysqli_fetch_assoc($result);\n    // Process payment using a payment gateway\n    // For example, using Stripe API\n    $amount = $row['total'];\n    $currency = 'USD';\n    $paymentMethod = 'card'; // Replace with actual payment method\n    try {\n      \\Stripe\\Stripe::setApiKey('YOUR_STRIPE_SECRET_KEY');\n      $charge = \\Stripe\\Charge::create(array(\n        'amount' => $amount,\n        'currency' => $currency,\n        'source' => $paymentMethod, // Replace with actual payment method\n        'description' => 'Purchase'\n      ));\n      if ($charge['status'] == 'succeeded') {\n        updateOrderTotal($orderId, $amount);\n      } else {\n        throw new Exception('Payment failed');\n      }\n    } catch (Exception $e) {\n      echo \"Error processing payment: \" . $e->getMessage();\n    }\n  }\n}\n\n// Example usage\nif ($_SERVER['REQUEST_METHOD'] == 'POST') {\n  if (isset($_POST['login'])) {\n    // Login user\n    $email = $_POST['email'];\n    $password = $_POST['password'];\n    if (authenticateUser($email, $password)) {\n      echo \"Logged in successfully\";\n    } else {\n      echo \"Invalid email or password\";\n    }\n  } elseif (isset($_POST['addToCart'])) {\n    // Add product to cart\n    $userId = $_SESSION['user_id']; // Replace with actual user ID\n    $productId = $_POST['product_id'];\n    addProductToCart($userId, $productId);\n  } elseif (isset($_POST['removeFromCart'])) {\n    // Remove product from cart\n    $orderId = $_POST['order_id'];\n    removeProductFromCart($orderId);\n  } elseif (isset($_POST['completePurchase'])) {\n    // Complete purchase\n    $userId = $_SESSION['user_id']; // Replace with actual user ID\n    completePurchase($userId);\n  }\n}\n\n?>\n```", null]}
