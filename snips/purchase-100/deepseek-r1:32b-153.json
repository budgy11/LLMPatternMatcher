{"prompt": "Create a purchase functionality using php", "llm_output": "<think>\nOkay, so the user wants to create a purchase functionality using PHP. I need to figure out how to approach this.\n\nFirst, I should outline what a basic purchase system entails. It probably needs product listing, showing details, adding to cart, and then checkout.\n\nI'll start by setting up the database. Creating tables for users, products, orders, and order items makes sense. Users will have their info, products will have details like name, price, description, and stock. Orders need user ID, total amount, and status. Order items link each product to an order with quantity and subtotal.\n\nNext, the login system is crucial. I'll need a registration page for new users and a login form. Using PHP sessions will help track logged-in users. I'll make sure to hash passwords securely using password_hash() and verify them with password_verify().\n\nThen, displaying products on a homepage. Fetching data from the database and showing each product in a card format. Each product should have an \"Add to Cart\" button which directs to another page or uses AJAX to add items without reloading.\n\nThe cart functionality is important. Using sessions here makes sense because it doesn't require a database connection for every cart update. I'll create functions to add, remove, and update items in the cart. When adding an item, check if it's already in the cart; if so, increment quantity, else add as new.\n\nFor checkout, users should see their cart details, enter shipping info, and confirm payment. I'll need a form that captures shipping address, maybe email for receipt, and then process the order upon submission.\n\nProcessing the order involves several steps: calculating total price, checking stock availability, inserting into orders table, updating product stock, adding each item to order_items, and emptying the cart. If any part fails, like insufficient stock, I'll handle that by rolling back or showing an error message.\n\nI should also think about user feedback\u2014display success messages after registration, login, logout, and order completion. Using $_SESSION['message'] can help with that.\n\nSecurity is a big concern. Sanitizing inputs to prevent SQL injection, using prepared statements or mysqli_real_escape_string(), validating email addresses, and ensuring sessions are secure with proper session management.\n\nTesting each part step by step is essential. Start with the database setup, then user registration/login, product display, cart operations, checkout process, and error handling.\n\nI might have missed some details, like payment integration which would require an API, but for now, a simple form submission suffices. Also, considering CSRF protection and secure cookies for sessions would be good practices to mention.\n\nIn the answer, I should structure it clearly, starting from database setup, moving through user authentication, product display, cart management, checkout process, order processing, and security considerations. Including code snippets with explanations will help the user understand each part.\n</think>\n\nHere's an example of a purchase functionality using PHP:\n\n**1. Database Setup**\n\nFirst, create a database table for storing products and orders:\n\n```sql\nCREATE TABLE products (\n    id INT PRIMARY KEY AUTO_INCREMENT,\n    name VARCHAR(255) NOT NULL,\n    price DECIMAL(10, 2) NOT NULL,\n    description TEXT,\n    stock INT NOT NULL\n);\n\nCREATE TABLE orders (\n    id INT PRIMARY KEY AUTO_INCREMENT,\n    user_id INT NOT NULL,\n    total_amount DECIMAL(10, 2) NOT NULL,\n    order_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n    status VARCHAR(50) NOT NULL\n);\n\nCREATE TABLE order_items (\n    id INT PRIMARY KEY AUTO_INCREMENT,\n    order_id INT NOT NULL,\n    product_id INT NOT NULL,\n    quantity INT NOT NULL,\n    subtotal DECIMAL(10, 2) NOT NULL\n);\n```\n\n**2. Product Display Page**\n\nCreate a page to display products:\n\n```php\n<?php\n// Connect to database\n$host = 'localhost';\n$username = 'root';\n$password = '';\n$dbname = 'purchase_system';\n\n$conn = mysqli_connect($host, $username, $password, $dbname);\n\nif (!$conn) {\n    die(\"Connection failed: \" . mysqli_connect_error());\n}\n\n// Fetch products from database\n$sql = \"SELECT * FROM products\";\n$result = mysqli_query($conn, $sql);\n?>\n\n<!DOCTYPE html>\n<html>\n<head>\n    <title>Product List</title>\n</head>\n<body>\n    <?php while ($row = mysqli_fetch_assoc($result)) { ?>\n        <div style=\"border: 1px solid #ddd; padding: 10px; margin: 5px;\">\n            <h3><?php echo $row['name']; ?></h3>\n            <p>Price: <?php echo $row['price']; ?>$</p>\n            <p>Description: <?php echo $row['description']; ?></p>\n            <form action=\"add_to_cart.php\" method=\"post\">\n                <input type=\"hidden\" name=\"product_id\" value=\"<?php echo $row['id']; ?>\">\n                <input type=\"number\" name=\"quantity\" min=\"1\" max=\"<?php echo $row['stock']; ?>\" value=\"1\">\n                <button type=\"submit\">Add to Cart</button>\n            </form>\n        </div>\n    <?php } ?>\n</body>\n</html>\n\n<?php\nmysqli_close($conn);\n?>\n```\n\n**3. Add to Cart Functionality**\n\nCreate `add_to_cart.php`:\n\n```php\n<?php\nsession_start();\n\n// Connect to database\n$host = 'localhost';\n$username = 'root';\n$password = '';\n$dbname = 'purchase_system';\n\n$conn = mysqli_connect($host, $username, $password, $dbname);\n\nif (!$conn) {\n    die(\"Connection failed: \" . mysqli_connect_error());\n}\n\n// Check if product exists and stock is sufficient\n$product_id = $_POST['product_id'];\n$quantity = $_POST['quantity'];\n\n$sql = \"SELECT * FROM products WHERE id = $product_id\";\n$result = mysqli_query($conn, $sql);\n$product = mysqli_fetch_assoc($result);\n\nif ($product && $quantity <= $product['stock']) {\n    // Add to cart\n    if (!isset($_SESSION['cart'])) {\n        $_SESSION['cart'] = array();\n    }\n\n    $item = array(\n        'id' => $product_id,\n        'name' => $product['name'],\n        'price' => $product['price'],\n        'quantity' => $quantity,\n        'subtotal' => $product['price'] * $quantity\n    );\n\n    $_SESSION['cart'][$product_id] = $item;\n}\n\nheader(\"Location: cart.php\");\n?>\n```\n\n**4. Cart Page**\n\nCreate `cart.php`:\n\n```php\n<?php\nsession_start();\n\n// Connect to database\n$host = 'localhost';\n$username = 'root';\n$password = '';\n$dbname = 'purchase_system';\n\n$conn = mysqli_connect($host, $username, $password, $dbname);\n\nif (!$conn) {\n    die(\"Connection failed: \" . mysqli_connect_error());\n}\n?>\n\n<!DOCTYPE html>\n<html>\n<head>\n    <title>Shopping Cart</title>\n</head>\n<body>\n    <?php if (isset($_SESSION['cart']) && count($_SESSION['cart']) > 0) { ?>\n        <h1>Your Cart</h1>\n        <table border=\"1\">\n            <tr>\n                <th>Product Name</th>\n                <th>Price</th>\n                <th>Quantity</th>\n                <th>Subtotal</th>\n                <th>Action</th>\n            </tr>\n            <?php foreach ($_SESSION['cart'] as $item) { ?>\n                <tr>\n                    <td><?php echo $item['name']; ?></td>\n                    <td><?php echo $item['price']; ?>$</td>\n                    <td>\n                        <form action=\"update_cart.php\" method=\"post\">\n                            <input type=\"hidden\" name=\"product_id\" value=\"<?php echo $item['id']; ?>\">\n                            <input type=\"number\" name=\"quantity\" min=\"1\" max=\"10\" value=\"<?php echo $item['quantity']; ?>\">\n                            <button type=\"submit\">Update</button>\n                        </form>\n                    </td>\n                    <td><?php echo $item['subtotal']; ?>$</td>\n                    <td><a href=\"remove_from_cart.php?product_id=<?php echo $item['id']; ?>\">Remove</a></td>\n                </tr>\n            <?php } ?>\n        </table>\n        <p>Total: <?php echo array_sum(array_column($_SESSION['cart'], 'subtotal')); ?>$</p>\n        <a href=\"checkout.php\">Proceed to Checkout</a>\n    <?php } else { ?>\n        <h1>Your cart is empty!</h1>\n        <a href=\"index.php\">Go back to shop</a>\n    <?php } ?>\n</body>\n</html>\n\n<?php\nmysqli_close($conn);\n?>\n```\n\n**5. Update Cart Functionality**\n\nCreate `update_cart.php`:\n\n```php\n<?php\nsession_start();\n\n// Connect to database\n$host = 'localhost';\n$username = 'root';\n$password = '';\n$dbname = 'purchase_system';\n\n$conn = mysqli_connect($host, $username, $password, $dbname);\n\nif (!$conn) {\n    die(\"Connection failed: \" . mysqli_connect_error());\n}\n\n// Update cart item\n$product_id = $_POST['product_id'];\n$quantity = $_POST['quantity'];\n\nif (isset($_SESSION['cart'][$product_id])) {\n    // Check if quantity is valid and stock is sufficient\n    $sql = \"SELECT stock FROM products WHERE id = $product_id\";\n    $result = mysqli_query($conn, $sql);\n    $stock = mysqli_fetch_assoc($result)['stock'];\n\n    if ($quantity <= $stock) {\n        $_SESSION['cart'][$product_id]['quantity'] = $quantity;\n        $_SESSION['cart'][$product_id]['subtotal'] = $_SESSION['cart'][$product_id]['price'] * $quantity;\n    }\n}\n\nheader(\"Location: cart.php\");\n?>\n```\n\n**6. Remove from Cart Functionality**\n\nCreate `remove_from_cart.php`:\n\n```php\n<?php\nsession_start();\n\n$product_id = $_GET['product_id'];\n\nif (isset($_SESSION['cart'][$product_id])) {\n    unset($_SESSION['cart'][$product_id]);\n}\n\nheader(\"Location: cart.php\");\n?>\n```\n\n**7. Checkout Page**\n\nCreate `checkout.php`:\n\n```php\n<?php\nsession_start();\n\n// Connect to database\n$host = 'localhost';\n$username = 'root';\n$password = '';\n$dbname = 'purchase_system';\n\n$conn = mysqli_connect($host, $username, $password, $dbname);\n\nif (!$conn) {\n    die(\"Connection failed: \" . mysqli_connect_error());\n}\n\n// Check if user is logged in\nif (!isset($_SESSION['user_id'])) {\n    header(\"Location: login.php\");\n}\n?>\n\n<!DOCTYPE html>\n<html>\n<head>\n    <title>Checkout</title>\n</head>\n<body>\n    <?php if (isset($_SESSION['cart']) && count($_SESSION['cart']) > 0) { ?>\n        <h1>Checkout</h1>\n        <form action=\"process_order.php\" method=\"post\">\n            <table border=\"1\">\n                <tr>\n                    <th>Product Name</th>\n                    <th>Price</th>\n                    <th>Quantity</th>\n                    <th>Subtotal</th>\n                </tr>\n                <?php foreach ($_SESSION['cart'] as $item) { ?>\n                    <tr>\n                        <td><?php echo $item['name']; ?></td>\n                        <td><?php echo $item['price']; ?>$</td>\n                        <td><?php echo $item['quantity']; ?></td>\n                        <td><?php echo $item['subtotal']; ?>$</td>\n                    </tr>\n                <?php } ?>\n            </table>\n            <p>Total: <?php echo array_sum(array_column($_SESSION['cart'], 'subtotal')); ?>$</p>\n\n            <h3>Shipping Information</h3>\n            <label for=\"name\">Name:</label><br>\n            <input type=\"text\" id=\"name\" name=\"name\" required><br><br>\n\n            <label for=\"email\">Email:</label><br>\n            <input type=\"email\" id=\"email\" name=\"email\" required><br><br>\n\n            <label for=\"address\">Address:</label><br>\n            <textarea id=\"address\" name=\"address\" rows=\"5\" cols=\"30\" required></textarea><br><br>\n\n            <button type=\"submit\">Place Order</button>\n        </form>\n    <?php } else { ?>\n        <h1>Your cart is empty!</h1>\n        <a href=\"index.php\">Go back to shop</a>\n    <?php } ?>\n</body>\n</html>\n\n<?php\nmysqli_close($conn);\n?>\n```\n\n**8. Order Processing**\n\nCreate `process_order.php`:\n\n```php\n<?php\nsession_start();\n\n// Connect to database\n$host = 'localhost';\n$username = 'root';\n$password = '';\n$dbname = 'purchase_system';\n\n$conn = mysqli_connect($host, $username, $password, $dbname);\n\nif (!$conn) {\n    die(\"Connection failed: \" . mysqli_connect_error());\n}\n\n// Check if user is logged in\nif (!isset($_SESSION['user_id'])) {\n    header(\"Location: login.php\");\n}\n\n// Get cart items\n$cart = $_SESSION['cart'];\n$total_amount = array_sum(array_column($cart, 'subtotal'));\n\n// Insert order into orders table\n$sql = \"INSERT INTO orders (user_id, total_amount, status) VALUES (?, ?, ?)\";\n$stmt = $conn->prepare($sql);\n$stmt->bind_param(\"ids\", $_SESSION['user_id'], $total_amount, \"pending\");\n$stmt->execute();\n$order_id = $stmt->insert_id;\n\n// Insert order items into order_items table\nforeach ($cart as $item) {\n    $sql = \"INSERT INTO order_items (order_id, product_id, quantity, subtotal) VALUES (?, ?, ?, ?)\";\n    $stmt = $conn->prepare($sql);\n    $stmt->bind_param(\"iiid\", $order_id, $item['id'], $item['quantity'], $item['subtotal']);\n    $stmt->execute();\n\n    // Update product stock\n    $sql = \"UPDATE products SET stock = stock - ? WHERE id = ?\";\n    $stmt = $conn->prepare($sql);\n    $stmt->bind_param(\"ii\", $item['quantity'], $item['id']);\n    $stmt->execute();\n}\n\n// Empty cart\nunset($_SESSION['cart']);\n\nheader(\"Location: order_confirmation.php?order_id=$order_id\");\n?>\n```\n\n**9. Order Confirmation Page**\n\nCreate `order_confirmation.php`:\n\n```php\n<?php\nsession_start();\n\n// Connect to database\n$host = 'localhost';\n$username = 'root';\n$password = '';\n$dbname = 'purchase_system';\n\n$conn = mysqli_connect($host, $username, $password, $dbname);\n\nif (!$conn) {\n    die(\"Connection failed: \" . mysqli_connect_error());\n}\n\n$order_id = $_GET['order_id'];\n\n// Fetch order details\n$sql = \"SELECT * FROM orders WHERE id = $order_id\";\n$result = mysqli_query($conn, $sql);\n$order = mysqli_fetch_assoc($result);\n\n// Fetch order items\n$sql = \"SELECT oi.*, p.name AS product_name FROM order_items oi JOIN products p ON oi.product_id = p.id WHERE oi.order_id = $order_id\";\n$result = mysqli_query($conn, $sql);\n?>\n\n<!DOCTYPE html>\n<html>\n<head>\n    <title>Order Confirmation</title>\n</head>\n<body>\n    <h1>Thank you for your order!</h1>\n    <p>Your order ID is: <?php echo $order['id']; ?></p>\n    <p>Total Amount: <?php echo $order['total_amount']; ?>$</p>\n\n    <h2>Order Details</h2>\n    <table border=\"1\">\n        <tr>\n            <th>Product Name</th>\n            <th>Quantity</th>\n            <th>Subtotal</th>\n        </tr>\n        <?php while ($item = mysqli_fetch_assoc($result)) { ?>\n            <tr>\n                <td><?php echo $item['product_name']; ?></td>\n                <td><?php echo $item['quantity']; ?></td>\n                <td><?php echo $item['subtotal']; ?>$</td>\n            </tr>\n        <?php } ?>\n    </table>\n\n    <p>Your order will be processed shortly. Check your email for confirmation.</p>\n</body>\n</html>\n\n<?php\nmysqli_close($conn);\n?>\n```\n\n**10. User Authentication**\n\nCreate a `login.php` and `register.php` page to handle user authentication.\n\nThis is a basic example of a purchase functionality using PHP. In a real-world application, you would need to add:\n\n- Error handling for all database operations\n- Input validation and sanitization\n- Secure password hashing\n- CSRF protection\n- Order status updates\n- Payment integration (e.g., PayPal, Stripe)\n- Email notifications\n- User profile management\n\nYou can customize this code according to your needs.", "code_blocks": [null, "```php\n<?php\n// Connect to database\n$host = 'localhost';\n$username = 'root';\n$password = '';\n$dbname = 'purchase_system';\n\n$conn = mysqli_connect($host, $username, $password, $dbname);\n\nif (!$conn) {\n    die(\"Connection failed: \" . mysqli_connect_error());\n}\n\n// Fetch products from database\n$sql = \"SELECT * FROM products\";\n$result = mysqli_query($conn, $sql);\n?>\n\n<!DOCTYPE html>\n<html>\n<head>\n    <title>Product List</title>\n</head>\n<body>\n    <?php while ($row = mysqli_fetch_assoc($result)) { ?>\n        <div style=\"border: 1px solid #ddd; padding: 10px; margin: 5px;\">\n            <h3><?php echo $row['name']; ?></h3>\n            <p>Price: <?php echo $row['price']; ?>$</p>\n            <p>Description: <?php echo $row['description']; ?></p>\n            <form action=\"add_to_cart.php\" method=\"post\">\n                <input type=\"hidden\" name=\"product_id\" value=\"<?php echo $row['id']; ?>\">\n                <input type=\"number\" name=\"quantity\" min=\"1\" max=\"<?php echo $row['stock']; ?>\" value=\"1\">\n                <button type=\"submit\">Add to Cart</button>\n            </form>\n        </div>\n    <?php } ?>\n</body>\n</html>\n\n<?php\nmysqli_close($conn);\n?>\n```", "```php\n<?php\nsession_start();\n\n// Connect to database\n$host = 'localhost';\n$username = 'root';\n$password = '';\n$dbname = 'purchase_system';\n\n$conn = mysqli_connect($host, $username, $password, $dbname);\n\nif (!$conn) {\n    die(\"Connection failed: \" . mysqli_connect_error());\n}\n\n// Check if product exists and stock is sufficient\n$product_id = $_POST['product_id'];\n$quantity = $_POST['quantity'];\n\n$sql = \"SELECT * FROM products WHERE id = $product_id\";\n$result = mysqli_query($conn, $sql);\n$product = mysqli_fetch_assoc($result);\n\nif ($product && $quantity <= $product['stock']) {\n    // Add to cart\n    if (!isset($_SESSION['cart'])) {\n        $_SESSION['cart'] = array();\n    }\n\n    $item = array(\n        'id' => $product_id,\n        'name' => $product['name'],\n        'price' => $product['price'],\n        'quantity' => $quantity,\n        'subtotal' => $product['price'] * $quantity\n    );\n\n    $_SESSION['cart'][$product_id] = $item;\n}\n\nheader(\"Location: cart.php\");\n?>\n```", "```php\n<?php\nsession_start();\n\n// Connect to database\n$host = 'localhost';\n$username = 'root';\n$password = '';\n$dbname = 'purchase_system';\n\n$conn = mysqli_connect($host, $username, $password, $dbname);\n\nif (!$conn) {\n    die(\"Connection failed: \" . mysqli_connect_error());\n}\n?>\n\n<!DOCTYPE html>\n<html>\n<head>\n    <title>Shopping Cart</title>\n</head>\n<body>\n    <?php if (isset($_SESSION['cart']) && count($_SESSION['cart']) > 0) { ?>\n        <h1>Your Cart</h1>\n        <table border=\"1\">\n            <tr>\n                <th>Product Name</th>\n                <th>Price</th>\n                <th>Quantity</th>\n                <th>Subtotal</th>\n                <th>Action</th>\n            </tr>\n            <?php foreach ($_SESSION['cart'] as $item) { ?>\n                <tr>\n                    <td><?php echo $item['name']; ?></td>\n                    <td><?php echo $item['price']; ?>$</td>\n                    <td>\n                        <form action=\"update_cart.php\" method=\"post\">\n                            <input type=\"hidden\" name=\"product_id\" value=\"<?php echo $item['id']; ?>\">\n                            <input type=\"number\" name=\"quantity\" min=\"1\" max=\"10\" value=\"<?php echo $item['quantity']; ?>\">\n                            <button type=\"submit\">Update</button>\n                        </form>\n                    </td>\n                    <td><?php echo $item['subtotal']; ?>$</td>\n                    <td><a href=\"remove_from_cart.php?product_id=<?php echo $item['id']; ?>\">Remove</a></td>\n                </tr>\n            <?php } ?>\n        </table>\n        <p>Total: <?php echo array_sum(array_column($_SESSION['cart'], 'subtotal')); ?>$</p>\n        <a href=\"checkout.php\">Proceed to Checkout</a>\n    <?php } else { ?>\n        <h1>Your cart is empty!</h1>\n        <a href=\"index.php\">Go back to shop</a>\n    <?php } ?>\n</body>\n</html>\n\n<?php\nmysqli_close($conn);\n?>\n```", "```php\n<?php\nsession_start();\n\n// Connect to database\n$host = 'localhost';\n$username = 'root';\n$password = '';\n$dbname = 'purchase_system';\n\n$conn = mysqli_connect($host, $username, $password, $dbname);\n\nif (!$conn) {\n    die(\"Connection failed: \" . mysqli_connect_error());\n}\n\n// Update cart item\n$product_id = $_POST['product_id'];\n$quantity = $_POST['quantity'];\n\nif (isset($_SESSION['cart'][$product_id])) {\n    // Check if quantity is valid and stock is sufficient\n    $sql = \"SELECT stock FROM products WHERE id = $product_id\";\n    $result = mysqli_query($conn, $sql);\n    $stock = mysqli_fetch_assoc($result)['stock'];\n\n    if ($quantity <= $stock) {\n        $_SESSION['cart'][$product_id]['quantity'] = $quantity;\n        $_SESSION['cart'][$product_id]['subtotal'] = $_SESSION['cart'][$product_id]['price'] * $quantity;\n    }\n}\n\nheader(\"Location: cart.php\");\n?>\n```", "```php\n<?php\nsession_start();\n\n$product_id = $_GET['product_id'];\n\nif (isset($_SESSION['cart'][$product_id])) {\n    unset($_SESSION['cart'][$product_id]);\n}\n\nheader(\"Location: cart.php\");\n?>\n```", "```php\n<?php\nsession_start();\n\n// Connect to database\n$host = 'localhost';\n$username = 'root';\n$password = '';\n$dbname = 'purchase_system';\n\n$conn = mysqli_connect($host, $username, $password, $dbname);\n\nif (!$conn) {\n    die(\"Connection failed: \" . mysqli_connect_error());\n}\n\n// Check if user is logged in\nif (!isset($_SESSION['user_id'])) {\n    header(\"Location: login.php\");\n}\n?>\n\n<!DOCTYPE html>\n<html>\n<head>\n    <title>Checkout</title>\n</head>\n<body>\n    <?php if (isset($_SESSION['cart']) && count($_SESSION['cart']) > 0) { ?>\n        <h1>Checkout</h1>\n        <form action=\"process_order.php\" method=\"post\">\n            <table border=\"1\">\n                <tr>\n                    <th>Product Name</th>\n                    <th>Price</th>\n                    <th>Quantity</th>\n                    <th>Subtotal</th>\n                </tr>\n                <?php foreach ($_SESSION['cart'] as $item) { ?>\n                    <tr>\n                        <td><?php echo $item['name']; ?></td>\n                        <td><?php echo $item['price']; ?>$</td>\n                        <td><?php echo $item['quantity']; ?></td>\n                        <td><?php echo $item['subtotal']; ?>$</td>\n                    </tr>\n                <?php } ?>\n            </table>\n            <p>Total: <?php echo array_sum(array_column($_SESSION['cart'], 'subtotal')); ?>$</p>\n\n            <h3>Shipping Information</h3>\n            <label for=\"name\">Name:</label><br>\n            <input type=\"text\" id=\"name\" name=\"name\" required><br><br>\n\n            <label for=\"email\">Email:</label><br>\n            <input type=\"email\" id=\"email\" name=\"email\" required><br><br>\n\n            <label for=\"address\">Address:</label><br>\n            <textarea id=\"address\" name=\"address\" rows=\"5\" cols=\"30\" required></textarea><br><br>\n\n            <button type=\"submit\">Place Order</button>\n        </form>\n    <?php } else { ?>\n        <h1>Your cart is empty!</h1>\n        <a href=\"index.php\">Go back to shop</a>\n    <?php } ?>\n</body>\n</html>\n\n<?php\nmysqli_close($conn);\n?>\n```", "```php\n<?php\nsession_start();\n\n// Connect to database\n$host = 'localhost';\n$username = 'root';\n$password = '';\n$dbname = 'purchase_system';\n\n$conn = mysqli_connect($host, $username, $password, $dbname);\n\nif (!$conn) {\n    die(\"Connection failed: \" . mysqli_connect_error());\n}\n\n// Check if user is logged in\nif (!isset($_SESSION['user_id'])) {\n    header(\"Location: login.php\");\n}\n\n// Get cart items\n$cart = $_SESSION['cart'];\n$total_amount = array_sum(array_column($cart, 'subtotal'));\n\n// Insert order into orders table\n$sql = \"INSERT INTO orders (user_id, total_amount, status) VALUES (?, ?, ?)\";\n$stmt = $conn->prepare($sql);\n$stmt->bind_param(\"ids\", $_SESSION['user_id'], $total_amount, \"pending\");\n$stmt->execute();\n$order_id = $stmt->insert_id;\n\n// Insert order items into order_items table\nforeach ($cart as $item) {\n    $sql = \"INSERT INTO order_items (order_id, product_id, quantity, subtotal) VALUES (?, ?, ?, ?)\";\n    $stmt = $conn->prepare($sql);\n    $stmt->bind_param(\"iiid\", $order_id, $item['id'], $item['quantity'], $item['subtotal']);\n    $stmt->execute();\n\n    // Update product stock\n    $sql = \"UPDATE products SET stock = stock - ? WHERE id = ?\";\n    $stmt = $conn->prepare($sql);\n    $stmt->bind_param(\"ii\", $item['quantity'], $item['id']);\n    $stmt->execute();\n}\n\n// Empty cart\nunset($_SESSION['cart']);\n\nheader(\"Location: order_confirmation.php?order_id=$order_id\");\n?>\n```", "```php\n<?php\nsession_start();\n\n// Connect to database\n$host = 'localhost';\n$username = 'root';\n$password = '';\n$dbname = 'purchase_system';\n\n$conn = mysqli_connect($host, $username, $password, $dbname);\n\nif (!$conn) {\n    die(\"Connection failed: \" . mysqli_connect_error());\n}\n\n$order_id = $_GET['order_id'];\n\n// Fetch order details\n$sql = \"SELECT * FROM orders WHERE id = $order_id\";\n$result = mysqli_query($conn, $sql);\n$order = mysqli_fetch_assoc($result);\n\n// Fetch order items\n$sql = \"SELECT oi.*, p.name AS product_name FROM order_items oi JOIN products p ON oi.product_id = p.id WHERE oi.order_id = $order_id\";\n$result = mysqli_query($conn, $sql);\n?>\n\n<!DOCTYPE html>\n<html>\n<head>\n    <title>Order Confirmation</title>\n</head>\n<body>\n    <h1>Thank you for your order!</h1>\n    <p>Your order ID is: <?php echo $order['id']; ?></p>\n    <p>Total Amount: <?php echo $order['total_amount']; ?>$</p>\n\n    <h2>Order Details</h2>\n    <table border=\"1\">\n        <tr>\n            <th>Product Name</th>\n            <th>Quantity</th>\n            <th>Subtotal</th>\n        </tr>\n        <?php while ($item = mysqli_fetch_assoc($result)) { ?>\n            <tr>\n                <td><?php echo $item['product_name']; ?></td>\n                <td><?php echo $item['quantity']; ?></td>\n                <td><?php echo $item['subtotal']; ?>$</td>\n            </tr>\n        <?php } ?>\n    </table>\n\n    <p>Your order will be processed shortly. Check your email for confirmation.</p>\n</body>\n</html>\n\n<?php\nmysqli_close($conn);\n?>\n```"]}
