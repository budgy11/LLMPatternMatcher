{"prompt": "Create a purchase functionality using php", "llm_output": "<think>\nAlright, the user asked how to create a purchase functionality using PHP. I need to provide a clear and comprehensive answer.\n\nFirst, I should outline the main components involved in such a system. That includes allowing users to view products, add them to their cart, proceed to checkout, process payment, confirm the order, and display an invoice.\n\nI'll start by considering the database structure. Products table with id, name, price, description, and image. Orders table for each purchase with user details and total amount. Order items to link orders with products and quantities.\n\nNext, I'll think about the necessary PHP files. index.php will display all products. cart.php will handle adding items and displaying the cart. checkout.php will process payment and finalize the order. invoice.php will show a thank you message and order details.\n\nFor each step, I'll need to explain how the user interacts with the system. Viewing products is straightforward, but adding to cart requires handling sessions to keep track of selected items. I should mention using $_SESSION to store cart data.\n\nIn checkout, processing payment might involve integrating a payment gateway, but for simplicity, I can simulate it with placeholders. Then, inserting order and order item records into the database is crucial for tracking purchases.\n\nSecurity is important, so I'll remind the user to sanitize inputs and use prepared statements to prevent SQL injection. Also, session management should be secure to protect user data.\n\nI should also touch on displaying errors or success messages appropriately. After each action, like adding to cart or completing payment, providing feedback enhances user experience.\n\nFinally, wrapping everything up with an invoice page that shows the order details helps confirm the transaction for the user. Including a thank you message and order summary makes it clear and professional.\n\nThroughout, I'll need to present code snippets without making them too long, just enough to guide the user through each part of the implementation. Keeping explanations simple but thorough should help the user understand how to build the purchase functionality step by step.\n</think>\n\nCreating a purchase functionality using PHP involves several steps, including:\n\n1. **Displaying Products**: Showing available products to users.\n2. **Adding to Cart**: Allowing users to add items to their shopping cart.\n3. **Checkout Process**: Handling payment and order details.\n4. **Processing Payment**: Simulating or integrating with a real payment gateway.\n5. **Order Confirmation**: Displaying an invoice after purchase.\n\nBelow is an example implementation:\n\n### 1. Database Structure\n\nFirst, create a database table for products and orders.\n\n```sql\nCREATE TABLE products (\n    id INT AUTO_INCREMENT PRIMARY KEY,\n    name VARCHAR(255),\n    price DECIMAL(10, 2),\n    description TEXT,\n    image VARCHAR(255)\n);\n\nCREATE TABLE orders (\n    order_id INT AUTO_INCREMENT PRIMARY KEY,\n    user_name VARCHAR(255),\n    email VARCHAR(255),\n    total_amount DECIMAL(10, 2),\n    order_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n\nCREATE TABLE order_items (\n    id INT AUTO_INCREMENT PRIMARY KEY,\n    order_id INT,\n    product_id INT,\n    quantity INT,\n    price DECIMAL(10, 2)\n);\n```\n\n### 2. Displaying Products (index.php)\n\n```php\n<?php\nsession_start();\nrequire 'db_connection.php';\n\n// Fetch products from database\n$products = mysqli_query($conn, \"SELECT * FROM products\");\n?>\n\n<!DOCTYPE html>\n<html>\n<head>\n    <title>Shop</title>\n</head>\n<body>\n    <h1>Products</h1>\n    <?php while ($product = mysqli_fetch_assoc($products)) { ?>\n        <div>\n            <img src=\"<?php echo $product['image']; ?>\" alt=\"<?php echo $product['name']; ?>\">\n            <h2><?php echo $product['name']; ?></h2>\n            <p><?php echo $product['description']; ?></p>\n            <p>Price: $<?php echo number_format($product['price'], 2); ?></p>\n            <form action=\"add_to_cart.php\" method=\"post\">\n                <input type=\"hidden\" name=\"id\" value=\"<?php echo $product['id']; ?>\">\n                <input type=\"number\" name=\"quantity\" min=\"1\" max=\"99\" placeholder=\"Quantity\">\n                <button type=\"submit\">Add to Cart</button>\n            </form>\n        </div>\n    <?php } ?>\n    <a href=\"cart.php\">View Cart</a>\n</body>\n</html>\n```\n\n### 3. Adding Items to Cart (add_to_cart.php)\n\n```php\n<?php\nsession_start();\nrequire 'db_connection.php';\n\nif ($_SERVER['REQUEST_METHOD'] == 'POST') {\n    $product_id = $_POST['id'];\n    $quantity = $_POST['quantity'];\n\n    // Get product details\n    $result = mysqli_query($conn, \"SELECT * FROM products WHERE id = '$product_id'\");\n    if ($row = mysqli_fetch_assoc($result)) {\n        $item = array(\n            'id' => $row['id'],\n            'name' => $row['name'],\n            'price' => $row['price'],\n            'quantity' => $quantity,\n            'image' => $row['image']\n        );\n\n        // Add to cart\n        if (isset($_SESSION['cart'])) {\n            $found = false;\n            foreach ($_SESSION['cart'] as &$item_in_cart) {\n                if ($item_in_cart['id'] == $item['id']) {\n                    $item_in_cart['quantity'] += $quantity;\n                    $found = true;\n                    break;\n                }\n            }\n            if (!$found) {\n                $_SESSION['cart'][] = $item;\n            }\n        } else {\n            $_SESSION['cart'] = array($item);\n        }\n    }\n\n    header('Location: cart.php');\n}\n?>\n```\n\n### 4. Cart Page (cart.php)\n\n```php\n<?php\nsession_start();\nrequire 'db_connection.php';\n?>\n\n<!DOCTYPE html>\n<html>\n<head>\n    <title>Shopping Cart</title>\n</head>\n<body>\n    <?php if (!empty($_SESSION['cart'])) { ?>\n        <h1>Your Shopping Cart</h1>\n        <table>\n            <thead>\n                <tr>\n                    <th>Image</th>\n                    <th>Name</th>\n                    <th>Price</th>\n                    <th>Quantity</th>\n                    <th>Total</th>\n                    <th>Action</th>\n                </tr>\n            </thead>\n            <tbody>\n                <?php\n                $total = 0;\n                foreach ($_SESSION['cart'] as $item) {\n                    $subtotal = $item['price'] * $item['quantity'];\n                    $total += $subtotal;\n                    ?>\n                    <tr>\n                        <td><img src=\"<?php echo $item['image']; ?>\" alt=\"<?php echo $item['name']; ?>\"></td>\n                        <td><?php echo $item['name']; ?></td>\n                        <td>$<?php echo number_format($item['price'], 2); ?></td>\n                        <td><?php echo $item['quantity']; ?></td>\n                        <td>$<?php echo number_format($subtotal, 2); ?></td>\n                        <td><a href=\"remove_from_cart.php?id=<?php echo $item['id']; ?>\">Remove</a></td>\n                    </tr>\n                <?php } ?>\n            </tbody>\n        </table>\n        <h2>Total: $<?php echo number_format($total, 2); ?></h2>\n        <form action=\"checkout.php\" method=\"post\">\n            <input type=\"hidden\" name=\"total_amount\" value=\"<?php echo $total; ?>\">\n            <button type=\"submit\">Checkout</button>\n        </form>\n    <?php } else { ?>\n        <p>Your cart is empty!</p>\n    <?php } ?>\n    <a href=\"index.php\">Back to Shop</a>\n</body>\n</html>\n```\n\n### 5. Checkout Page (checkout.php)\n\n```php\n<?php\nsession_start();\nrequire 'db_connection.php';\n\nif ($_SERVER['REQUEST_METHOD'] == 'POST') {\n    $total_amount = $_POST['total_amount'];\n    \n    // Get user details\n    $user_name = isset($_POST['name']) ? mysqli_real_escape_string($conn, $_POST['name']) : '';\n    $email = isset($_POST['email']) ? mysqli_real_escape_string($conn, $_POST['email']) : '';\n\n    if (empty($user_name) || empty($email)) {\n        die(\"Please fill in all required fields!\");\n    }\n\n    // Insert order into database\n    $order_query = \"INSERT INTO orders (user_name, email, total_amount) VALUES ('$user_name', '$email', '$total_amount')\";\n    mysqli_query($conn, $order_query);\n    $order_id = mysqli_insert_id($conn);\n\n    // Insert order items\n    foreach ($_SESSION['cart'] as $item) {\n        $insert_item = \"INSERT INTO order_items (order_id, product_id, quantity, price)\n                        VALUES ('$order_id', '{$item['id']}', '{$item['quantity']}', '{$item['price']}')\";\n        mysqli_query($conn, $insert_item);\n    }\n\n    // Clear cart\n    unset($_SESSION['cart']);\n    \n    // Redirect to invoice page\n    header('Location: invoice.php?order_id=' . $order_id);\n} else {\n    ?>\n    <h1>Checkout</h1>\n    <form method=\"post\" action=\"<?php echo $_SERVER['PHP_SELF']; ?>\">\n        <div>\n            <label for=\"name\">Name:</label><br>\n            <input type=\"text\" id=\"name\" name=\"name\" required><br>\n\n            <label for=\"email\">Email:</label><br>\n            <input type=\"email\" id=\"email\" name=\"email\" required><br>\n\n            <input type=\"hidden\" name=\"total_amount\" value=\"<?php echo $total; ?>\">\n            <button type=\"submit\">Place Order</button>\n        </div>\n    </form>\n    <?php\n}\n?>\n```\n\n### 6. Invoice Page (invoice.php)\n\n```php\n<?php\nsession_start();\nrequire 'db_connection.php';\n\n$order_id = isset($_GET['order_id']) ? $_GET['order_id'] : '';\n\nif ($order_id) {\n    $order_query = \"SELECT * FROM orders WHERE order_id = '$order_id'\";\n    $result = mysqli_query($conn, $order_query);\n    $order = mysqli_fetch_assoc($result);\n\n    $items_query = \"SELECT oi.*, p.name AS product_name \n                    FROM order_items oi\n                    JOIN products p ON oi.product_id = p.id \n                    WHERE oi.order_id = '$order_id'\";\n    $items_result = mysqli_query($conn, $items_query);\n    $items = array();\n    while ($item = mysqli_fetch_assoc($items_result)) {\n        $items[] = $item;\n    }\n} else {\n    die(\"Invalid order ID!\");\n}\n?>\n\n<!DOCTYPE html>\n<html>\n<head>\n    <title>Invoice</title>\n</head>\n<body>\n    <h1>Thank You for Your Order!</h1>\n    <p>Your order has been received. Order ID: <?php echo $order_id; ?></p>\n    \n    <h2>Billing Information:</h2>\n    <p>Name: <?php echo $order['user_name']; ?></p>\n    <p>Email: <?php echo $order['email']; ?></p>\n    \n    <h2>Order Details:</h2>\n    <table>\n        <thead>\n            <tr>\n                <th>Product</th>\n                <th>Quantity</th>\n                <th>Price</th>\n                <th>Total</th>\n            </tr>\n        </thead>\n        <tbody>\n            <?php foreach ($items as $item) { ?>\n                <tr>\n                    <td><?php echo $item['product_name']; ?></td>\n                    <td><?php echo $item['quantity']; ?></td>\n                    <td>$<?php echo number_format($item['price'], 2); ?></td>\n                    <td>$<?php echo number_format($item['price'] * $item['quantity'], 2); ?></td>\n                </tr>\n            <?php } ?>\n        </tbody>\n    </table>\n    \n    <h2>Total Amount: $<?php echo number_format($order['total_amount'], 2); ?></h2>\n</body>\n</html>\n```\n\n### Explanation:\n\n1. **Products Display**: The `index.php` file fetches and displays all products from the database.\n2. **Adding to Cart**: The `add_to_cart.php` file adds selected products to the user's shopping cart stored in `$_SESSION['cart']`.\n3. **Cart Management**: The `cart.php` file displays the current items in the shopping cart, allowing users to view and modify their order.\n4. **Checkout Process**: The `checkout.php` file collects user details and processes the payment (simulated here).\n5. **Order Confirmation**: The `invoice.php` file displays a thank you message along with the order details.\n\n### Important Notes:\n\n- **Security**: Always sanitize inputs and use prepared statements to prevent SQL injection.\n- **Error Handling**: Add proper error handling for form submissions and database operations.\n- **Payment Gateway Integration**: In a real application, replace the simulated payment process with an actual payment gateway integration (e.g., Stripe, PayPal).\n- **Session Management**: Use secure session management practices to protect user data.\n\nThis is a basic implementation that you can customize further based on your requirements.", "code_blocks": [null, "```php\n<?php\nsession_start();\nrequire 'db_connection.php';\n\n// Fetch products from database\n$products = mysqli_query($conn, \"SELECT * FROM products\");\n?>\n\n<!DOCTYPE html>\n<html>\n<head>\n    <title>Shop</title>\n</head>\n<body>\n    <h1>Products</h1>\n    <?php while ($product = mysqli_fetch_assoc($products)) { ?>\n        <div>\n            <img src=\"<?php echo $product['image']; ?>\" alt=\"<?php echo $product['name']; ?>\">\n            <h2><?php echo $product['name']; ?></h2>\n            <p><?php echo $product['description']; ?></p>\n            <p>Price: $<?php echo number_format($product['price'], 2); ?></p>\n            <form action=\"add_to_cart.php\" method=\"post\">\n                <input type=\"hidden\" name=\"id\" value=\"<?php echo $product['id']; ?>\">\n                <input type=\"number\" name=\"quantity\" min=\"1\" max=\"99\" placeholder=\"Quantity\">\n                <button type=\"submit\">Add to Cart</button>\n            </form>\n        </div>\n    <?php } ?>\n    <a href=\"cart.php\">View Cart</a>\n</body>\n</html>\n```", "```php\n<?php\nsession_start();\nrequire 'db_connection.php';\n\nif ($_SERVER['REQUEST_METHOD'] == 'POST') {\n    $product_id = $_POST['id'];\n    $quantity = $_POST['quantity'];\n\n    // Get product details\n    $result = mysqli_query($conn, \"SELECT * FROM products WHERE id = '$product_id'\");\n    if ($row = mysqli_fetch_assoc($result)) {\n        $item = array(\n            'id' => $row['id'],\n            'name' => $row['name'],\n            'price' => $row['price'],\n            'quantity' => $quantity,\n            'image' => $row['image']\n        );\n\n        // Add to cart\n        if (isset($_SESSION['cart'])) {\n            $found = false;\n            foreach ($_SESSION['cart'] as &$item_in_cart) {\n                if ($item_in_cart['id'] == $item['id']) {\n                    $item_in_cart['quantity'] += $quantity;\n                    $found = true;\n                    break;\n                }\n            }\n            if (!$found) {\n                $_SESSION['cart'][] = $item;\n            }\n        } else {\n            $_SESSION['cart'] = array($item);\n        }\n    }\n\n    header('Location: cart.php');\n}\n?>\n```", "```php\n<?php\nsession_start();\nrequire 'db_connection.php';\n?>\n\n<!DOCTYPE html>\n<html>\n<head>\n    <title>Shopping Cart</title>\n</head>\n<body>\n    <?php if (!empty($_SESSION['cart'])) { ?>\n        <h1>Your Shopping Cart</h1>\n        <table>\n            <thead>\n                <tr>\n                    <th>Image</th>\n                    <th>Name</th>\n                    <th>Price</th>\n                    <th>Quantity</th>\n                    <th>Total</th>\n                    <th>Action</th>\n                </tr>\n            </thead>\n            <tbody>\n                <?php\n                $total = 0;\n                foreach ($_SESSION['cart'] as $item) {\n                    $subtotal = $item['price'] * $item['quantity'];\n                    $total += $subtotal;\n                    ?>\n                    <tr>\n                        <td><img src=\"<?php echo $item['image']; ?>\" alt=\"<?php echo $item['name']; ?>\"></td>\n                        <td><?php echo $item['name']; ?></td>\n                        <td>$<?php echo number_format($item['price'], 2); ?></td>\n                        <td><?php echo $item['quantity']; ?></td>\n                        <td>$<?php echo number_format($subtotal, 2); ?></td>\n                        <td><a href=\"remove_from_cart.php?id=<?php echo $item['id']; ?>\">Remove</a></td>\n                    </tr>\n                <?php } ?>\n            </tbody>\n        </table>\n        <h2>Total: $<?php echo number_format($total, 2); ?></h2>\n        <form action=\"checkout.php\" method=\"post\">\n            <input type=\"hidden\" name=\"total_amount\" value=\"<?php echo $total; ?>\">\n            <button type=\"submit\">Checkout</button>\n        </form>\n    <?php } else { ?>\n        <p>Your cart is empty!</p>\n    <?php } ?>\n    <a href=\"index.php\">Back to Shop</a>\n</body>\n</html>\n```", "```php\n<?php\nsession_start();\nrequire 'db_connection.php';\n\nif ($_SERVER['REQUEST_METHOD'] == 'POST') {\n    $total_amount = $_POST['total_amount'];\n    \n    // Get user details\n    $user_name = isset($_POST['name']) ? mysqli_real_escape_string($conn, $_POST['name']) : '';\n    $email = isset($_POST['email']) ? mysqli_real_escape_string($conn, $_POST['email']) : '';\n\n    if (empty($user_name) || empty($email)) {\n        die(\"Please fill in all required fields!\");\n    }\n\n    // Insert order into database\n    $order_query = \"INSERT INTO orders (user_name, email, total_amount) VALUES ('$user_name', '$email', '$total_amount')\";\n    mysqli_query($conn, $order_query);\n    $order_id = mysqli_insert_id($conn);\n\n    // Insert order items\n    foreach ($_SESSION['cart'] as $item) {\n        $insert_item = \"INSERT INTO order_items (order_id, product_id, quantity, price)\n                        VALUES ('$order_id', '{$item['id']}', '{$item['quantity']}', '{$item['price']}')\";\n        mysqli_query($conn, $insert_item);\n    }\n\n    // Clear cart\n    unset($_SESSION['cart']);\n    \n    // Redirect to invoice page\n    header('Location: invoice.php?order_id=' . $order_id);\n} else {\n    ?>\n    <h1>Checkout</h1>\n    <form method=\"post\" action=\"<?php echo $_SERVER['PHP_SELF']; ?>\">\n        <div>\n            <label for=\"name\">Name:</label><br>\n            <input type=\"text\" id=\"name\" name=\"name\" required><br>\n\n            <label for=\"email\">Email:</label><br>\n            <input type=\"email\" id=\"email\" name=\"email\" required><br>\n\n            <input type=\"hidden\" name=\"total_amount\" value=\"<?php echo $total; ?>\">\n            <button type=\"submit\">Place Order</button>\n        </div>\n    </form>\n    <?php\n}\n?>\n```", "```php\n<?php\nsession_start();\nrequire 'db_connection.php';\n\n$order_id = isset($_GET['order_id']) ? $_GET['order_id'] : '';\n\nif ($order_id) {\n    $order_query = \"SELECT * FROM orders WHERE order_id = '$order_id'\";\n    $result = mysqli_query($conn, $order_query);\n    $order = mysqli_fetch_assoc($result);\n\n    $items_query = \"SELECT oi.*, p.name AS product_name \n                    FROM order_items oi\n                    JOIN products p ON oi.product_id = p.id \n                    WHERE oi.order_id = '$order_id'\";\n    $items_result = mysqli_query($conn, $items_query);\n    $items = array();\n    while ($item = mysqli_fetch_assoc($items_result)) {\n        $items[] = $item;\n    }\n} else {\n    die(\"Invalid order ID!\");\n}\n?>\n\n<!DOCTYPE html>\n<html>\n<head>\n    <title>Invoice</title>\n</head>\n<body>\n    <h1>Thank You for Your Order!</h1>\n    <p>Your order has been received. Order ID: <?php echo $order_id; ?></p>\n    \n    <h2>Billing Information:</h2>\n    <p>Name: <?php echo $order['user_name']; ?></p>\n    <p>Email: <?php echo $order['email']; ?></p>\n    \n    <h2>Order Details:</h2>\n    <table>\n        <thead>\n            <tr>\n                <th>Product</th>\n                <th>Quantity</th>\n                <th>Price</th>\n                <th>Total</th>\n            </tr>\n        </thead>\n        <tbody>\n            <?php foreach ($items as $item) { ?>\n                <tr>\n                    <td><?php echo $item['product_name']; ?></td>\n                    <td><?php echo $item['quantity']; ?></td>\n                    <td>$<?php echo number_format($item['price'], 2); ?></td>\n                    <td>$<?php echo number_format($item['price'] * $item['quantity'], 2); ?></td>\n                </tr>\n            <?php } ?>\n        </tbody>\n    </table>\n    \n    <h2>Total Amount: $<?php echo number_format($order['total_amount'], 2); ?></h2>\n</body>\n</html>\n```"]}
