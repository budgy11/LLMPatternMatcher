{"prompt": "Create a forgot password function using php", "llm_output": "Here is an example of how to create a \"forgot password\" function using PHP:\n\n**Note:** This is a basic implementation and you should consider adding additional security measures such as email verification, IP blocking, etc.\n\n**Database Schema:**\n\nLet's assume we have the following database schema:\n```sql\nCREATE TABLE users (\n  id INT PRIMARY KEY AUTO_INCREMENT,\n  username VARCHAR(255),\n  email VARCHAR(255) UNIQUE,\n  password_hash VARCHAR(255)\n);\n```\n**PHP Code:**\n```php\n<?php\n\n// Configuration\n$db_host = 'localhost';\n$db_username = 'your_username';\n$db_password = 'your_password';\n$db_name = 'your_database';\n\n// Connect to database\n$conn = new mysqli($db_host, $db_username, $db_password, $db_name);\n\nif ($conn->connect_error) {\n    die(\"Connection failed: \" . $conn->connect_error);\n}\n\nfunction sendForgotPasswordEmail($email, $token) {\n    // Send email using your preferred method (e.g. PHPMailer)\n    $subject = 'Reset Your Password';\n    $body = 'Click the link below to reset your password:<br><a href=\"' . $_SERVER['HTTP_HOST'] . '/reset-password.php?token=' . $token . '\">Reset Password</a>';\n    mail($email, $subject, $body);\n}\n\nfunction forgotPassword() {\n    if ($_SERVER['REQUEST_METHOD'] == 'POST') {\n        // Get email from form\n        $email = $_POST['email'];\n\n        // Validate email\n        if (!filter_var($email, FILTER_VALIDATE_EMAIL)) {\n            echo \"Invalid email address.\";\n            return;\n        }\n\n        // Query database to get user data\n        $query = \"SELECT * FROM users WHERE email='\" . mysqli_real_escape_string($conn, $email) . \"'\";\n        $result = mysqli_query($conn, $query);\n\n        if (mysqli_num_rows($result) > 0) {\n            // Get user data\n            $user = mysqli_fetch_assoc($result);\n            $token = bin2hex(random_bytes(32));\n\n            // Update token in database\n            $query = \"UPDATE users SET token='\" . mysqli_real_escape_string($conn, $token) . \"' WHERE email='\" . mysqli_real_escape_string($conn, $email) . \"'\";\n            mysqli_query($conn, $query);\n\n            // Send forgot password email\n            sendForgotPasswordEmail($email, $token);\n        } else {\n            echo \"No account found with this email.\";\n        }\n    }\n}\n\nfunction resetPassword() {\n    if ($_SERVER['REQUEST_METHOD'] == 'POST') {\n        // Get token from URL\n        $token = $_GET['token'];\n\n        // Validate token\n        if (!$token) {\n            echo \"Invalid token.\";\n            return;\n        }\n\n        // Query database to get user data\n        $query = \"SELECT * FROM users WHERE token='\" . mysqli_real_escape_string($conn, $token) . \"'\";\n        $result = mysqli_query($conn, $query);\n\n        if (mysqli_num_rows($result) > 0) {\n            // Get user data\n            $user = mysqli_fetch_assoc($result);\n            echo \"Please enter new password:<br>\";\n            echo \"<form action='reset-password.php' method='post'>\";\n            echo \"<input type='password' name='new_password'><br>\";\n            echo \"<input type='submit' value='Submit'>\";\n            echo \"</form>\";\n\n            if ($_SERVER['REQUEST_METHOD'] == 'POST') {\n                // Get new password\n                $new_password = $_POST['new_password'];\n\n                // Validate new password\n                if (strlen($new_password) < 8 || !preg_match(\"#[a-zA-Z]#\", $new_password) || !preg_match(\"#[0-9]#\", $new_password)) {\n                    echo \"Invalid new password.\";\n                } else {\n                    // Update password in database\n                    $query = \"UPDATE users SET password_hash='\" . mysqli_real_escape_string($conn, hash('sha256', $new_password)) . \"' WHERE token='\" . mysqli_real_escape_string($conn, $token) . \"'\";\n                    mysqli_query($conn, $query);\n\n                    // Remove token from database\n                    $query = \"UPDATE users SET token=NULL WHERE token='\" . mysqli_real_escape_string($conn, $token) . \"'\";\n                    mysqli_query($conn, $query);\n                }\n            }\n        } else {\n            echo \"Invalid token.\";\n        }\n    }\n}\n\n// Forgot password form\nif (isset($_GET['forgot-password'])) {\n    ?>\n    <form action=\"<?php echo $_SERVER['PHP_SELF']; ?>\" method=\"post\">\n        Email: <input type=\"email\" name=\"email\"><br>\n        <input type=\"submit\" value=\"Send Reset Link\">\n    </form>\n    <?php\n}\n\n// Reset password form\nif (isset($_GET['token'])) {\n    ?>\n    <h2>Reset Password</h2>\n    <?php\n    resetPassword();\n} else if ($_SERVER['REQUEST_METHOD'] == 'POST') {\n    forgotPassword();\n}\n?>\n```\n**Explanation:**\n\n1. The `sendForgotPasswordEmail()` function sends a reset password email to the user with a token.\n2. The `forgotPassword()` function handles the forgot password form submission:\n\t* It gets the email from the form and validates it.\n\t* It queries the database to get the user data.\n\t* If the user exists, it generates a random token and updates the user's token in the database.\n\t* It sends the reset password email with the token.\n3. The `resetPassword()` function handles the reset password form submission:\n\t* It gets the token from the URL and validates it.\n\t* It queries the database to get the user data using the token.\n\t* If the user exists, it displays a new password form.\n\t* When the new password is submitted, it updates the user's password in the database.\n\n**Note:** This implementation uses `mysqli` extension for database interaction. Make sure to replace the placeholders with your actual database credentials and schema. Additionally, you should consider adding additional security measures such as email verification, IP blocking, etc.", "code_blocks": [null, "```php\n<?php\n\n// Configuration\n$db_host = 'localhost';\n$db_username = 'your_username';\n$db_password = 'your_password';\n$db_name = 'your_database';\n\n// Connect to database\n$conn = new mysqli($db_host, $db_username, $db_password, $db_name);\n\nif ($conn->connect_error) {\n    die(\"Connection failed: \" . $conn->connect_error);\n}\n\nfunction sendForgotPasswordEmail($email, $token) {\n    // Send email using your preferred method (e.g. PHPMailer)\n    $subject = 'Reset Your Password';\n    $body = 'Click the link below to reset your password:<br><a href=\"' . $_SERVER['HTTP_HOST'] . '/reset-password.php?token=' . $token . '\">Reset Password</a>';\n    mail($email, $subject, $body);\n}\n\nfunction forgotPassword() {\n    if ($_SERVER['REQUEST_METHOD'] == 'POST') {\n        // Get email from form\n        $email = $_POST['email'];\n\n        // Validate email\n        if (!filter_var($email, FILTER_VALIDATE_EMAIL)) {\n            echo \"Invalid email address.\";\n            return;\n        }\n\n        // Query database to get user data\n        $query = \"SELECT * FROM users WHERE email='\" . mysqli_real_escape_string($conn, $email) . \"'\";\n        $result = mysqli_query($conn, $query);\n\n        if (mysqli_num_rows($result) > 0) {\n            // Get user data\n            $user = mysqli_fetch_assoc($result);\n            $token = bin2hex(random_bytes(32));\n\n            // Update token in database\n            $query = \"UPDATE users SET token='\" . mysqli_real_escape_string($conn, $token) . \"' WHERE email='\" . mysqli_real_escape_string($conn, $email) . \"'\";\n            mysqli_query($conn, $query);\n\n            // Send forgot password email\n            sendForgotPasswordEmail($email, $token);\n        } else {\n            echo \"No account found with this email.\";\n        }\n    }\n}\n\nfunction resetPassword() {\n    if ($_SERVER['REQUEST_METHOD'] == 'POST') {\n        // Get token from URL\n        $token = $_GET['token'];\n\n        // Validate token\n        if (!$token) {\n            echo \"Invalid token.\";\n            return;\n        }\n\n        // Query database to get user data\n        $query = \"SELECT * FROM users WHERE token='\" . mysqli_real_escape_string($conn, $token) . \"'\";\n        $result = mysqli_query($conn, $query);\n\n        if (mysqli_num_rows($result) > 0) {\n            // Get user data\n            $user = mysqli_fetch_assoc($result);\n            echo \"Please enter new password:<br>\";\n            echo \"<form action='reset-password.php' method='post'>\";\n            echo \"<input type='password' name='new_password'><br>\";\n            echo \"<input type='submit' value='Submit'>\";\n            echo \"</form>\";\n\n            if ($_SERVER['REQUEST_METHOD'] == 'POST') {\n                // Get new password\n                $new_password = $_POST['new_password'];\n\n                // Validate new password\n                if (strlen($new_password) < 8 || !preg_match(\"#[a-zA-Z]#\", $new_password) || !preg_match(\"#[0-9]#\", $new_password)) {\n                    echo \"Invalid new password.\";\n                } else {\n                    // Update password in database\n                    $query = \"UPDATE users SET password_hash='\" . mysqli_real_escape_string($conn, hash('sha256', $new_password)) . \"' WHERE token='\" . mysqli_real_escape_string($conn, $token) . \"'\";\n                    mysqli_query($conn, $query);\n\n                    // Remove token from database\n                    $query = \"UPDATE users SET token=NULL WHERE token='\" . mysqli_real_escape_string($conn, $token) . \"'\";\n                    mysqli_query($conn, $query);\n                }\n            }\n        } else {\n            echo \"Invalid token.\";\n        }\n    }\n}\n\n// Forgot password form\nif (isset($_GET['forgot-password'])) {\n    ?>\n    <form action=\"<?php echo $_SERVER['PHP_SELF']; ?>\" method=\"post\">\n        Email: <input type=\"email\" name=\"email\"><br>\n        <input type=\"submit\" value=\"Send Reset Link\">\n    </form>\n    <?php\n}\n\n// Reset password form\nif (isset($_GET['token'])) {\n    ?>\n    <h2>Reset Password</h2>\n    <?php\n    resetPassword();\n} else if ($_SERVER['REQUEST_METHOD'] == 'POST') {\n    forgotPassword();\n}\n?>\n```"]}
