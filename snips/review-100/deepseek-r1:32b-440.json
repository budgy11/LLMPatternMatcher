{"prompt": "Create a user review function using php", "llm_output": "<think>\nAlright, the user wants to create a user review function using PHP. I need to figure out what exactly they're looking for. They might be building a website where users can leave reviews, like a product or service page.\n\nFirst, I should outline the main components needed. A review system typically includes capturing user input, storing it, displaying it, and allowing ratings. So, I'll break it down into functions: display reviews, submit a new review, calculate average rating, and count the total reviews.\n\nI'll start by considering the database structure. The reviews table should have fields like id, product_id, user_name, review_text, rating, and submission date. This helps in organizing the data properly.\n\nNext, connecting to the database is essential. Using mysqli is a good choice since it's secure and widely used. I'll include placeholders for host, username, password, and database name so the user can fill those in.\n\nFor displaying reviews, I'll write a function that fetches all reviews for a specific product. It should show each review with the user's name, their comment, and their rating using stars. This makes it visually appealing and easy to read.\n\nSubmitting a new review requires handling user input securely. I'll use prepared statements to prevent SQL injection. The function will take user inputs, sanitize them, and insert into the database. After submission, redirecting back to the product page keeps the user flow smooth.\n\nCalculating the average rating is another key part. This function will compute the average from all ratings for a product and round it to one decimal place. It also counts the total reviews to display how many there are.\n\nI should include examples of how to use these functions on an HTML page, showing form elements for submitting a review and sections for displaying the results. Using inline CSS for stars can make the rating visually clear.\n\nSecurity is important, so I'll remind the user about sanitizing inputs and securing database connections. Error handling is also necessary but wasn't fully covered here, so I might suggest adding try-catch blocks or checking for errors in queries.\n\nFinally, I'll consider additional features they might want, like allowing edits or deletions, sorting reviews by date, or implementing a moderation system. But since the user asked for a basic function, I'll keep it simple and mention these as possible enhancements.\n\nOverall, the goal is to provide a clear, functional set of PHP functions that handle the review process from submission to display, ensuring security and usability.\n</think>\n\nHere's an example of a user review function using PHP:\n\nThis example includes:\n1. Displaying reviews\n2. Submitting new reviews\n3. Calculating average rating\n4. Rating system (stars)\n\n```php\n<?php\n// Database connection details\n$host = 'localhost';\n$username = 'username';\n$password = 'password';\n$dbname = 'database_name';\n\n// Connect to database\n$conn = mysqli_connect($host, $username, $password, $dbname);\nif (!$conn) {\n    die(\"Connection failed: \" . mysqli_connect_error());\n}\n\n// Function to display reviews for a product\nfunction display_reviews($product_id) {\n    global $conn;\n    \n    $sql = \"SELECT * FROM reviews WHERE product_id = ? ORDER BY submission_date DESC\";\n    $stmt = mysqli_prepare($conn, $sql);\n    mysqli_stmt_bind_param($stmt, \"i\", $product_id);\n    mysqli_stmt_execute($stmt);\n    $result = mysqli_stmt_get_result($stmt);\n    \n    while ($row = mysqli_fetch_assoc($result)) {\n        echo \"<div class='review'>\";\n        echo \"<h4>Written by: \" . htmlspecialchars($row['user_name']) . \"</h4>\";\n        echo \"<p>\" . htmlspecialchars($row['review_text']) . \"</p>\";\n        echo \"<div class='rating'>\";\n        for ($i = 1; $i <= 5; $i++) {\n            if ($i <= $row['rating']) {\n                echo \"<span class='star'>\u2605</span>\";\n            } else {\n                echo \"<span class='star'>\u2606</span>\";\n            }\n        }\n        echo \"</div>\";\n        echo \"</div>\";\n    }\n}\n\n// Function to submit a new review\nfunction submit_review($product_id, $user_name, $review_text, $rating) {\n    global $conn;\n    \n    // Sanitize inputs\n    $product_id = mysqli_real_escape_string($conn, $product_id);\n    $user_name = htmlspecialchars(mysqli_real_escape_string($conn, $user_name));\n    $review_text = htmlspecialchars(mysqli_real_escape_string($conn, $review_text));\n    $rating = (int)$rating;\n    \n    // Insert review into database\n    $sql = \"INSERT INTO reviews (product_id, user_name, review_text, rating, submission_date) \n            VALUES (?, ?, ?, ?, NOW())\";\n    $stmt = mysqli_prepare($conn, $sql);\n    mysqli_stmt_bind_param($stmt, \"isii\", $product_id, $user_name, $review_text, $rating);\n    \n    if (mysqli_stmt_execute($stmt)) {\n        return true;\n    } else {\n        return false;\n    }\n}\n\n// Function to calculate average rating\nfunction get_average_rating($product_id) {\n    global $conn;\n    \n    $sql = \"SELECT AVG(rating) as average FROM reviews WHERE product_id = ?\";\n    $stmt = mysqli_prepare($conn, $sql);\n    mysqli_stmt_bind_param($stmt, \"i\", $product_id);\n    mysqli_stmt_execute($stmt);\n    $result = mysqli_stmt_get_result($stmt);\n    \n    if ($row = mysqli_fetch_assoc($result)) {\n        return round($row['average'], 1);\n    } else {\n        return 0;\n    }\n}\n\n// Function to count total reviews\nfunction get_review_count($product_id) {\n    global $conn;\n    \n    $sql = \"SELECT COUNT(*) as count FROM reviews WHERE product_id = ?\";\n    $stmt = mysqli_prepare($conn, $sql);\n    mysqli_stmt_bind_param($stmt, \"i\", $product_id);\n    mysqli_stmt_execute($stmt);\n    $result = mysqli_stmt_get_result($stmt);\n    \n    if ($row = mysqli_fetch_assoc($result)) {\n        return $row['count'];\n    } else {\n        return 0;\n    }\n}\n\n// Example usage:\n$product_id = 1; // Replace with actual product ID\n\nif ($_SERVER[\"REQUEST_METHOD\"] == \"POST\") {\n    $user_name = $_POST['user_name'];\n    $review_text = $_POST['review_text'];\n    $rating = $_POST['rating'];\n    \n    if (submit_review($product_id, $user_name, $review_text, $rating)) {\n        echo \"Thank you for submitting your review!\";\n    } else {\n        echo \"Error submitting review. Please try again.\";\n    }\n}\n?>\n\n<!DOCTYPE html>\n<html>\n<head>\n    <title>Product Reviews</title>\n    <style>\n        .star { color: #gold; }\n        .review { border: 1px solid #ddd; padding: 10px; margin: 5px 0; }\n        .rating { display: inline-block; margin-top: 5px; }\n    </style>\n</head>\n<body>\n\n<h2>Product Reviews</h2>\n\n<!-- Review Submission Form -->\n<form method=\"post\" action=\"<?php echo $_SERVER['PHP_SELF']; ?>\">\n    <input type=\"hidden\" name=\"product_id\" value=\"<?php echo $product_id; ?>\">\n    <div>\n        <label for=\"user_name\">Your Name:</label><br>\n        <input type=\"text\" id=\"user_name\" name=\"user_name\" required>\n    </div>\n    \n    <div>\n        <label for=\"review_text\">Review:</label><br>\n        <textarea id=\"review_text\" name=\"review_text\" rows=\"4\" cols=\"50\" required></textarea>\n    </div>\n    \n    <div>\n        <label>Rating:</label><br>\n        <input type=\"radio\" name=\"rating\" value=\"5\"> \u2605\u2605\u2605\u2605\u2605<br>\n        <input type=\"radio\" name=\"rating\" value=\"4\"> \u2605\u2605\u2605\u2605\u2606<br>\n        <input type=\"radio\" name=\"rating\" value=\"3\"> \u2605\u2605\u2605\u2606\u2606<br>\n        <input type=\"radio\" name=\"rating\" value=\"2\"> \u2605\u2605\u2606\u2606\u2606<br>\n        <input type=\"radio\" name=\"rating\" value=\"1\"> \u2605\u2606\u2606\u2606\u2606<br>\n    </div>\n    \n    <button type=\"submit\">Submit Review</button>\n</form>\n\n<!-- Display Reviews -->\n<h3>Customer Reviews</h3>\n<?php\ndisplay_reviews($product_id);\n?>\n\n<!-- Display Average Rating and Review Count -->\n<div style=\"margin-top: 20px;\">\n    <?php\n    $average_rating = get_average_rating($product_id);\n    $review_count = get_review_count($product_id);\n    \n    echo \"<p>Average Rating: $average_rating/5 ($review_count reviews)</p>\";\n    ?>\n</div>\n\n</body>\n</html>\n```\n\nThis code includes:\n\n1. A `submit_review()` function to handle new review submissions\n2. A `display_reviews()` function to show existing reviews\n3. Functions to calculate average rating and count total reviews\n4. HTML form for submitting new reviews\n5. CSS styling for the reviews display\n\nFeatures:\n- Sanitizes input data to prevent SQL injection\n- Displays reviews with user names, comments, and ratings\n- Shows average rating and number of reviews\n- Uses stars to visually represent ratings\n- Secure database connection using mysqli\n\nTo use this code:\n\n1. Replace the database connection details at the top\n2. Make sure your database has a `reviews` table with appropriate columns:\n   - id (INT, AUTO_INCREMENT)\n   - product_id (INT)\n   - user_name (VARCHAR)\n   - review_text (TEXT)\n   - rating (INT)\n   - submission_date (DATETIME)\n\n3. You can customize the styling by modifying the CSS\n\nTo improve security:\n- Add error handling\n- Implement CAPTCHA to prevent spam\n- Add validation for input fields\n- Use prepared statements consistently\n- Sanitize output data when displaying it\n\nYou can also extend this code by adding features like:\n- Review editing and deletion (for administrators)\n- Sorting reviews by date or rating\n- Pagination for long lists of reviews\n- User authentication system\n- Moderation system for reviews", "code_blocks": ["```php\n<?php\n// Database connection details\n$host = 'localhost';\n$username = 'username';\n$password = 'password';\n$dbname = 'database_name';\n\n// Connect to database\n$conn = mysqli_connect($host, $username, $password, $dbname);\nif (!$conn) {\n    die(\"Connection failed: \" . mysqli_connect_error());\n}\n\n// Function to display reviews for a product\nfunction display_reviews($product_id) {\n    global $conn;\n    \n    $sql = \"SELECT * FROM reviews WHERE product_id = ? ORDER BY submission_date DESC\";\n    $stmt = mysqli_prepare($conn, $sql);\n    mysqli_stmt_bind_param($stmt, \"i\", $product_id);\n    mysqli_stmt_execute($stmt);\n    $result = mysqli_stmt_get_result($stmt);\n    \n    while ($row = mysqli_fetch_assoc($result)) {\n        echo \"<div class='review'>\";\n        echo \"<h4>Written by: \" . htmlspecialchars($row['user_name']) . \"</h4>\";\n        echo \"<p>\" . htmlspecialchars($row['review_text']) . \"</p>\";\n        echo \"<div class='rating'>\";\n        for ($i = 1; $i <= 5; $i++) {\n            if ($i <= $row['rating']) {\n                echo \"<span class='star'>\u2605</span>\";\n            } else {\n                echo \"<span class='star'>\u2606</span>\";\n            }\n        }\n        echo \"</div>\";\n        echo \"</div>\";\n    }\n}\n\n// Function to submit a new review\nfunction submit_review($product_id, $user_name, $review_text, $rating) {\n    global $conn;\n    \n    // Sanitize inputs\n    $product_id = mysqli_real_escape_string($conn, $product_id);\n    $user_name = htmlspecialchars(mysqli_real_escape_string($conn, $user_name));\n    $review_text = htmlspecialchars(mysqli_real_escape_string($conn, $review_text));\n    $rating = (int)$rating;\n    \n    // Insert review into database\n    $sql = \"INSERT INTO reviews (product_id, user_name, review_text, rating, submission_date) \n            VALUES (?, ?, ?, ?, NOW())\";\n    $stmt = mysqli_prepare($conn, $sql);\n    mysqli_stmt_bind_param($stmt, \"isii\", $product_id, $user_name, $review_text, $rating);\n    \n    if (mysqli_stmt_execute($stmt)) {\n        return true;\n    } else {\n        return false;\n    }\n}\n\n// Function to calculate average rating\nfunction get_average_rating($product_id) {\n    global $conn;\n    \n    $sql = \"SELECT AVG(rating) as average FROM reviews WHERE product_id = ?\";\n    $stmt = mysqli_prepare($conn, $sql);\n    mysqli_stmt_bind_param($stmt, \"i\", $product_id);\n    mysqli_stmt_execute($stmt);\n    $result = mysqli_stmt_get_result($stmt);\n    \n    if ($row = mysqli_fetch_assoc($result)) {\n        return round($row['average'], 1);\n    } else {\n        return 0;\n    }\n}\n\n// Function to count total reviews\nfunction get_review_count($product_id) {\n    global $conn;\n    \n    $sql = \"SELECT COUNT(*) as count FROM reviews WHERE product_id = ?\";\n    $stmt = mysqli_prepare($conn, $sql);\n    mysqli_stmt_bind_param($stmt, \"i\", $product_id);\n    mysqli_stmt_execute($stmt);\n    $result = mysqli_stmt_get_result($stmt);\n    \n    if ($row = mysqli_fetch_assoc($result)) {\n        return $row['count'];\n    } else {\n        return 0;\n    }\n}\n\n// Example usage:\n$product_id = 1; // Replace with actual product ID\n\nif ($_SERVER[\"REQUEST_METHOD\"] == \"POST\") {\n    $user_name = $_POST['user_name'];\n    $review_text = $_POST['review_text'];\n    $rating = $_POST['rating'];\n    \n    if (submit_review($product_id, $user_name, $review_text, $rating)) {\n        echo \"Thank you for submitting your review!\";\n    } else {\n        echo \"Error submitting review. Please try again.\";\n    }\n}\n?>\n\n<!DOCTYPE html>\n<html>\n<head>\n    <title>Product Reviews</title>\n    <style>\n        .star { color: #gold; }\n        .review { border: 1px solid #ddd; padding: 10px; margin: 5px 0; }\n        .rating { display: inline-block; margin-top: 5px; }\n    </style>\n</head>\n<body>\n\n<h2>Product Reviews</h2>\n\n<!-- Review Submission Form -->\n<form method=\"post\" action=\"<?php echo $_SERVER['PHP_SELF']; ?>\">\n    <input type=\"hidden\" name=\"product_id\" value=\"<?php echo $product_id; ?>\">\n    <div>\n        <label for=\"user_name\">Your Name:</label><br>\n        <input type=\"text\" id=\"user_name\" name=\"user_name\" required>\n    </div>\n    \n    <div>\n        <label for=\"review_text\">Review:</label><br>\n        <textarea id=\"review_text\" name=\"review_text\" rows=\"4\" cols=\"50\" required></textarea>\n    </div>\n    \n    <div>\n        <label>Rating:</label><br>\n        <input type=\"radio\" name=\"rating\" value=\"5\"> \u2605\u2605\u2605\u2605\u2605<br>\n        <input type=\"radio\" name=\"rating\" value=\"4\"> \u2605\u2605\u2605\u2605\u2606<br>\n        <input type=\"radio\" name=\"rating\" value=\"3\"> \u2605\u2605\u2605\u2606\u2606<br>\n        <input type=\"radio\" name=\"rating\" value=\"2\"> \u2605\u2605\u2606\u2606\u2606<br>\n        <input type=\"radio\" name=\"rating\" value=\"1\"> \u2605\u2606\u2606\u2606\u2606<br>\n    </div>\n    \n    <button type=\"submit\">Submit Review</button>\n</form>\n\n<!-- Display Reviews -->\n<h3>Customer Reviews</h3>\n<?php\ndisplay_reviews($product_id);\n?>\n\n<!-- Display Average Rating and Review Count -->\n<div style=\"margin-top: 20px;\">\n    <?php\n    $average_rating = get_average_rating($product_id);\n    $review_count = get_review_count($product_id);\n    \n    echo \"<p>Average Rating: $average_rating/5 ($review_count reviews)</p>\";\n    ?>\n</div>\n\n</body>\n</html>\n```"]}
