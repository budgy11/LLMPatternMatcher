{"prompt": "Create a user review function using php", "llm_output": "<think>\nOkay, I need to create a PHP function for handling user reviews. Let me think about what this function should do.\n\nFirst, the function needs to accept parameters like review text, rating, user ID, and product ID. These are essential because each review is tied to a specific user and product.\n\nNext, I should connect to the database. Using mysqli would be good for security and performance. I'll need to include configuration settings, so maybe creating a config.php file that holds the database details makes sense.\n\nThen, I have to validate the input. The review can't be empty, and the rating must be between 1 and 5. If these checks fail, I should return an error message.\n\nAfter validation, inserting the data into the database is the next step. I'll use a prepared statement with placeholders to prevent SQL injection. This makes the query safer and more efficient.\n\nIf the insertion is successful, I should probably update the product's average rating. To do this, I'll calculate the new average by fetching the current total ratings and count, then updating the product table accordingly. Again, using prepared statements here is important for security.\n\nI need to handle any potential errors during database operations. If something goes wrong with the insert or update, returning an appropriate error message will help in debugging.\n\nFinally, if everything works out, I'll return a success message indicating that the review was added successfully.\n\nPutting it all together, the function should connect, validate, insert, update averages, handle errors, and provide feedback. Also, including the config file at the top ensures that database settings are accessible within the function.\n</think>\n\nHere's an example of a user review function in PHP:\n\n```php\n<?php\n// Include database configuration\nrequire_once('config.php');\n\nfunction addReview($reviewText, $rating, $userId, $productId) {\n    // Connect to the database\n    $conn = new mysqli(DB_HOST, DB_USER, DB_PASSWORD, DB_NAME);\n\n    // Check connection\n    if ($conn->connect_error) {\n        die(\"Connection failed: \" . $conn->connect_error);\n        return false;\n    }\n\n    // Validate input\n    if (empty($reviewText) || !is_numeric($rating) || $rating < 1 || $rating > 5) {\n        echo \"Invalid review data!\";\n        return false;\n    }\n\n    try {\n        // Escape special characters to prevent SQL injection\n        $reviewText = mysqli_real_escape_string($conn, $reviewText);\n        \n        // Insert the review into the reviews table\n        $sql = \"INSERT INTO reviews (review_text, rating, user_id, product_id, review_date) \n                VALUES (?, ?, ?, ?, NOW())\";\n                \n        $stmt = $conn->prepare($sql);\n        $stmt->bind_param(\"ssii\", $reviewText, $rating, $userId, $productId);\n\n        if ($stmt->execute()) {\n            // Update the average rating for the product\n            $sqlAvg = \"UPDATE products SET \n                        average_rating = (SELECT AVG(rating) FROM reviews WHERE product_id = ?),\n                        review_count = (SELECT COUNT(*) FROM reviews WHERE product_id = ?)\n                      WHERE id = ?\";\n            \n            $stmtAvg = $conn->prepare($sqlAvg);\n            $stmtAvg->bind_param(\"iii\", $productId, $productId, $productId);\n            \n            if ($stmtAvg->execute()) {\n                return true;\n            } else {\n                echo \"Error updating average rating: \" . $stmtAvg->error;\n                return false;\n            }\n        } else {\n            echo \"Error adding review: \" . $stmt->error;\n            return false;\n        }\n    } catch (Exception $e) {\n        echo \"Error: \" . $e->getMessage();\n        return false;\n    } finally {\n        // Close database connection\n        $conn->close();\n    }\n}\n\n// Example usage:\n// require_once('config.php');\n// $reviewText = $_POST['review'];\n// $rating = $_POST['rating'];\n// $userId = 1; // Get from session or authentication\n// $productId = 1; // Get from URL parameter\n\n// if (addReview($reviewText, $rating, $userId, $productId)) {\n//     echo \"Review added successfully!\";\n// } else {\n//     echo \"Failed to add review.\";\n// }\n?>\n```\n\nThis function includes:\n\n1. Database connection setup\n2. Input validation\n3. SQL injection prevention\n4. Review insertion into the database\n5. Updating product average rating and review count\n6. Error handling\n7. Proper cleanup (closing database connections)\n\nTo use this function:\n\n1. Create a `config.php` file with your database credentials:\n```php\n<?php\ndefine('DB_HOST', 'localhost');\ndefine('DB_USER', 'your_username');\ndefine('DB_PASSWORD', 'your_password');\ndefine('DB_NAME', 'your_database_name');\n?>\n```\n\n2. Make sure you have the necessary tables in your database:\n\n- `users` table with at least an `id` column\n- `products` table with at least an `id`, `average_rating`, and `review_count` columns\n- `reviews` table with:\n  - `id` (primary key)\n  - `user_id` (foreign key to users.id)\n  - `product_id` (foreign key to products.id)\n  - `review_text`\n  - `rating`\n  - `review_date`\n\n3. Call the function with user input from a form or API endpoint\n\nImportant security notes:\n- Always validate and sanitize user input\n- Use prepared statements to prevent SQL injection\n- Make sure to handle errors appropriately\n- Secure your database credentials in the config file\n\nYou can extend this function by adding features like:\n- Review editing/deletion\n- User authentication checks\n- Rate limiting\n- Spam detection\n- Review moderation\n- Sorting and filtering reviews\n- Displaying review statistics", "code_blocks": ["```php\n<?php\n// Include database configuration\nrequire_once('config.php');\n\nfunction addReview($reviewText, $rating, $userId, $productId) {\n    // Connect to the database\n    $conn = new mysqli(DB_HOST, DB_USER, DB_PASSWORD, DB_NAME);\n\n    // Check connection\n    if ($conn->connect_error) {\n        die(\"Connection failed: \" . $conn->connect_error);\n        return false;\n    }\n\n    // Validate input\n    if (empty($reviewText) || !is_numeric($rating) || $rating < 1 || $rating > 5) {\n        echo \"Invalid review data!\";\n        return false;\n    }\n\n    try {\n        // Escape special characters to prevent SQL injection\n        $reviewText = mysqli_real_escape_string($conn, $reviewText);\n        \n        // Insert the review into the reviews table\n        $sql = \"INSERT INTO reviews (review_text, rating, user_id, product_id, review_date) \n                VALUES (?, ?, ?, ?, NOW())\";\n                \n        $stmt = $conn->prepare($sql);\n        $stmt->bind_param(\"ssii\", $reviewText, $rating, $userId, $productId);\n\n        if ($stmt->execute()) {\n            // Update the average rating for the product\n            $sqlAvg = \"UPDATE products SET \n                        average_rating = (SELECT AVG(rating) FROM reviews WHERE product_id = ?),\n                        review_count = (SELECT COUNT(*) FROM reviews WHERE product_id = ?)\n                      WHERE id = ?\";\n            \n            $stmtAvg = $conn->prepare($sqlAvg);\n            $stmtAvg->bind_param(\"iii\", $productId, $productId, $productId);\n            \n            if ($stmtAvg->execute()) {\n                return true;\n            } else {\n                echo \"Error updating average rating: \" . $stmtAvg->error;\n                return false;\n            }\n        } else {\n            echo \"Error adding review: \" . $stmt->error;\n            return false;\n        }\n    } catch (Exception $e) {\n        echo \"Error: \" . $e->getMessage();\n        return false;\n    } finally {\n        // Close database connection\n        $conn->close();\n    }\n}\n\n// Example usage:\n// require_once('config.php');\n// $reviewText = $_POST['review'];\n// $rating = $_POST['rating'];\n// $userId = 1; // Get from session or authentication\n// $productId = 1; // Get from URL parameter\n\n// if (addReview($reviewText, $rating, $userId, $productId)) {\n//     echo \"Review added successfully!\";\n// } else {\n//     echo \"Failed to add review.\";\n// }\n?>\n```", "```php\n<?php\ndefine('DB_HOST', 'localhost');\ndefine('DB_USER', 'your_username');\ndefine('DB_PASSWORD', 'your_password');\ndefine('DB_NAME', 'your_database_name');\n?>\n```"]}
