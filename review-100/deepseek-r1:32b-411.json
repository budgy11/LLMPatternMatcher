{"prompt": "Create a user review function using php", "llm_output": "<think>\nAlright, the user wants to create a user review function using PHP. I need to figure out what that entails.\n\nFirst, I should consider the main components of a review system. Users will leave reviews with ratings and comments, so I'll need functions to add, retrieve, and display these reviews.\n\nI'll start by setting up a database connection. Using mysqli is a good choice since it's widely supported and secure. I'll include placeholders for the host, user, password, and database name.\n\nNext, I need functions to handle adding reviews. The add_review function will take parameters like user_id, product_id, rating, and comment. It should insert this data into the reviews table, ensuring proper escaping to prevent SQL injection.\n\nThen, retrieving reviews is essential. The get_reviews function will fetch all reviews for a specific product, joining with the users table to get usernames. Ordering by date makes sense so the latest reviews appear first.\n\nDisplaying the reviews neatly is important. The display_reviews function will loop through each review and format them into HTML elements. I'll include the user's name, rating as stars, comment, and date.\n\nI should also handle cases where there are no reviews yet, showing a helpful message instead of an empty list.\n\nSecurity is a priority, so using prepared statements with placeholders would be better, but for simplicity, I used mysqli_real_escape_string. I'll note that prepared statements are more secure.\n\nFinally, I'll provide example usage to show how these functions can be integrated into a web page, including the necessary HTML structure and CSS styling for ratings.\n\nPutting it all together, I'll outline each function step by step, ensuring they're well-structured and easy to understand. Testing with sample data would help verify everything works as expected.\n</think>\n\nHere's an example of a user review system in PHP:\n\n```php\n<?php\n// Database connection\n$mysqli = new mysqli('localhost', 'username', 'password', 'database_name');\n\n// Function to add a new review\nfunction add_review($user_id, $product_id, $rating, $comment) {\n    global $mysqli;\n    \n    // Sanitize input\n    $user_id = intval($user_id);\n    $product_id = intval($product_id);\n    $rating = intval($rating);\n    $comment = mysqli_real_escape_string($mysqli, htmlspecialchars($comment));\n    \n    // Check if rating is between 1 and 5\n    if ($rating < 1 || $rating > 5) {\n        return false;\n    }\n    \n    // Insert review into database\n    $query = \"INSERT INTO reviews (user_id, product_id, rating, comment, date_added)\n              VALUES ('$user_id', '$product_id', '$rating', '$comment', NOW())\";\n    \n    if ($mysqli->query($query)) {\n        return true;\n    } else {\n        return false;\n    }\n}\n\n// Function to get reviews for a specific product\nfunction get_reviews($product_id) {\n    global $mysqli;\n    \n    $product_id = intval($product_id);\n    \n    // Get reviews from database\n    $query = \"SELECT r.*, u.username \n              FROM reviews r \n              JOIN users u ON r.user_id = u.id \n              WHERE r.product_id = '$product_id' \n              ORDER BY r.date_added DESC\";\n    \n    $result = $mysqli->query($query);\n    \n    if ($result->num_rows > 0) {\n        return $result;\n    } else {\n        return false;\n    }\n}\n\n// Function to display reviews\nfunction display_reviews($product_id) {\n    $reviews = get_reviews($product_id);\n    \n    if ($reviews) {\n        echo '<div class=\"reviews\">';\n        \n        while ($row = $reviews->fetch_assoc()) {\n            $user_name = $row['username'];\n            $rating = $row['rating'];\n            $comment = htmlspecialchars_decode($row['comment']);\n            $date = date('F j, Y', strtotime($row['date_added']));\n            \n            echo '<div class=\"review\">';\n                echo \"<h4>Review by $user_name</h4>\";\n                echo \"<p><strong>Rating:</strong> $rating/5</p>\";\n                echo \"<p><strong>Comment:</strong> $comment</p>\";\n                echo \"<small>Reviewed on $date</small>\";\n            echo '</div>';\n        }\n        \n        echo '</div>';\n    } else {\n        echo '<p>No reviews available for this product.</p>';\n    }\n}\n\n// Example usage:\nif (isset($_POST['submit_review'])) {\n    // Assuming user is logged in and has a valid session\n    $user_id = $_SESSION['user_id'];\n    $product_id = $_GET['product_id']; // Make sure to validate this\n    \n    $rating = $_POST['rating'];\n    $comment = $_POST['comment'];\n    \n    if (add_review($user_id, $product_id, $rating, $comment)) {\n        echo 'Review added successfully!';\n    } else {\n        echo 'Error adding review. Please try again.';\n    }\n}\n\n// Display reviews for a product\nif (isset($_GET['product_id'])) {\n    display_reviews($_GET['product_id']);\n}\n?>\n```\n\nThis code includes:\n\n1. A database connection setup\n\n2. `add_review()` function:\n   - Adds a new review to the database\n   - Sanitizes input data\n   - Validates rating value (must be between 1-5)\n\n3. `get_reviews()` function:\n   - Retrieves reviews for a specific product\n   - Joins with users table to get user names\n\n4. `display_reviews()` function:\n   - Displays formatted reviews on the page\n   - Shows username, rating, comment, and date added\n\nTo use this code:\n\n1. Create a database table named `reviews` with columns:\n   - id (INT AUTO_INCREMENT PRIMARY KEY)\n   - user_id (INT)\n   - product_id (INT)\n   - rating (TINYINT)\n   - comment (TEXT)\n   - date_added (DATETIME)\n\n2. Ensure you have a users table with at least an `id` and `username` column\n\n3. Add a review form in your HTML:\n\n```html\n<form method=\"post\" action=\"\">\n    <input type=\"hidden\" name=\"product_id\" value=\"<?php echo $product_id; ?>\">\n    \n    <div class=\"rating\">\n        <label>Rating:</label>\n        <select name=\"rating\">\n            <option value=\"5\">5 stars</option>\n            <option value=\"4\">4 stars</option>\n            <option value=\"3\">3 stars</option>\n            <option value=\"2\">2 stars</option>\n            <option value=\"1\">1 star</option>\n        </select>\n    </div>\n\n    <div class=\"comment\">\n        <label>Comment:</label>\n        <textarea name=\"comment\" rows=\"5\"></textarea>\n    </div>\n\n    <input type=\"submit\" name=\"submit_review\" value=\"Submit Review\">\n</form>\n```\n\n4. Add some CSS to style the ratings:\n\n```css\n.rating {\n    padding: 10px;\n}\n\n.review {\n    border: 1px solid #ddd;\n    margin-bottom: 20px;\n    padding: 15px;\n}\n\n.review h4 {\n    margin-top: 0;\n}\n```\n\nRemember to:\n- Sanitize and validate all input data\n- Secure your database connection\n- Use prepared statements instead of direct queries in a production environment\n- Handle errors properly\n- Add proper validation for user sessions\n- Implement rate limiting to prevent abuse\n\nThis is a basic example, you might want to add features like:\n- Review editing/deletion\n- Flagging inappropriate content\n- Sorting reviews by helpfulness or date\n- More detailed user information in reviews\n- Loading reviews asynchronously with AJAX", "code_blocks": ["```php\n<?php\n// Database connection\n$mysqli = new mysqli('localhost', 'username', 'password', 'database_name');\n\n// Function to add a new review\nfunction add_review($user_id, $product_id, $rating, $comment) {\n    global $mysqli;\n    \n    // Sanitize input\n    $user_id = intval($user_id);\n    $product_id = intval($product_id);\n    $rating = intval($rating);\n    $comment = mysqli_real_escape_string($mysqli, htmlspecialchars($comment));\n    \n    // Check if rating is between 1 and 5\n    if ($rating < 1 || $rating > 5) {\n        return false;\n    }\n    \n    // Insert review into database\n    $query = \"INSERT INTO reviews (user_id, product_id, rating, comment, date_added)\n              VALUES ('$user_id', '$product_id', '$rating', '$comment', NOW())\";\n    \n    if ($mysqli->query($query)) {\n        return true;\n    } else {\n        return false;\n    }\n}\n\n// Function to get reviews for a specific product\nfunction get_reviews($product_id) {\n    global $mysqli;\n    \n    $product_id = intval($product_id);\n    \n    // Get reviews from database\n    $query = \"SELECT r.*, u.username \n              FROM reviews r \n              JOIN users u ON r.user_id = u.id \n              WHERE r.product_id = '$product_id' \n              ORDER BY r.date_added DESC\";\n    \n    $result = $mysqli->query($query);\n    \n    if ($result->num_rows > 0) {\n        return $result;\n    } else {\n        return false;\n    }\n}\n\n// Function to display reviews\nfunction display_reviews($product_id) {\n    $reviews = get_reviews($product_id);\n    \n    if ($reviews) {\n        echo '<div class=\"reviews\">';\n        \n        while ($row = $reviews->fetch_assoc()) {\n            $user_name = $row['username'];\n            $rating = $row['rating'];\n            $comment = htmlspecialchars_decode($row['comment']);\n            $date = date('F j, Y', strtotime($row['date_added']));\n            \n            echo '<div class=\"review\">';\n                echo \"<h4>Review by $user_name</h4>\";\n                echo \"<p><strong>Rating:</strong> $rating/5</p>\";\n                echo \"<p><strong>Comment:</strong> $comment</p>\";\n                echo \"<small>Reviewed on $date</small>\";\n            echo '</div>';\n        }\n        \n        echo '</div>';\n    } else {\n        echo '<p>No reviews available for this product.</p>';\n    }\n}\n\n// Example usage:\nif (isset($_POST['submit_review'])) {\n    // Assuming user is logged in and has a valid session\n    $user_id = $_SESSION['user_id'];\n    $product_id = $_GET['product_id']; // Make sure to validate this\n    \n    $rating = $_POST['rating'];\n    $comment = $_POST['comment'];\n    \n    if (add_review($user_id, $product_id, $rating, $comment)) {\n        echo 'Review added successfully!';\n    } else {\n        echo 'Error adding review. Please try again.';\n    }\n}\n\n// Display reviews for a product\nif (isset($_GET['product_id'])) {\n    display_reviews($_GET['product_id']);\n}\n?>\n```", null, null]}
