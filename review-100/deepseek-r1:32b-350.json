{"prompt": "Create a user review function using php", "llm_output": "<think>\nOkay, I need to create a user review function using PHP. Let me think about how to approach this.\n\nFirst, the function should allow users to leave reviews and ratings for products or services. So, I'll need a form where users can input their name, email, rating from 1 to 5 stars, and their comment. That makes sense.\n\nNext, I have to handle the submission of this form. When the user submits their review, the data needs to be processed. I should validate each field to make sure they're not empty. For example, if the name is missing or the email isn't valid, I should display an error message and prevent submission.\n\nThen, after validation, the next step is storing the review in a database. I'll need a MySQL table for this. The table should include fields like id, product_id (to link reviews to specific products), user_name, user_email, rating, comment, and timestamp for when the review was submitted.\n\nI remember that using prepared statements with mysqli can help prevent SQL injection attacks. So, I'll use mysqli_stmt_bind_param to safely insert the data into the database.\n\nAfter successfully inserting the data, it's good practice to show a success message to the user so they know their review was posted.\n\nNow, displaying the reviews is another important part. The function should retrieve all reviews for a specific product from the database and display them on the page. I'll write a query to fetch these reviews, order them by the most recent first, which means ordering by timestamp in descending order.\n\nFor each review fetched, I need to output the user's name, their rating as stars, their comment, and the date they submitted it. The date should be formatted nicely, maybe using PHP's date function to convert the timestamp into a readable format like \"d/m/Y H:i\".\n\nI also want to include an average rating display. This means calculating the average of all ratings for that product and showing it as both a numerical value and stars. To do this, I'll run another query to get the sum of ratings divided by the count of reviews.\n\nSecurity is crucial here. I should ensure that user inputs are sanitized to prevent any potential attacks. Using mysqli_real_escape_string can help with that when inserting into the database.\n\nAdditionally, I need to handle cases where no reviews have been submitted yet. In such a case, the function should inform the user that there are no reviews available.\n\nPutting it all together, I'll structure the code into sections: handling form submission and validation, storing the review in the database, fetching and displaying existing reviews, calculating the average rating, and ensuring proper error handling and security measures throughout.\n\nI think I've covered all the main points. Now, let me write out the PHP function with these considerations in mind.\n</think>\n\nHere's an example of a user review system using PHP:\n\n```php\n<?php\n// Review submission and display function\nfunction handleReviews($product_id) {\n    // Database connection\n    $conn = mysqli_connect(\"localhost\", \"username\", \"password\", \"database_name\");\n    \n    if (!$conn) {\n        die(\"Connection failed: \" . mysqli_connect_error());\n    }\n\n    // Submit review\n    if (isset($_POST['submit_review'])) {\n        // Sanitize inputs\n        $name = mysqli_real_escape_string($conn, $_POST['reviewer_name']);\n        $email = mysqli_real_escape_string($conn, $_POST['reviewer_email']);\n        $rating = intval($_POST['rating']);\n        $comment = mysqli_real_escape_string($conn, $_POST['comment']);\n\n        // Validate inputs\n        if (empty($name) || empty($email) || empty($rating) || empty($comment)) {\n            echo \"Please fill in all fields.\";\n        } else {\n            // Insert review into database\n            $stmt = mysqli_prepare($conn, \"INSERT INTO reviews (product_id, user_name, user_email, rating, comment, timestamp) VALUES (?, ?, ?, ?, ?, CURRENT_TIMESTAMP)\");\n            mysqli_stmt_bind_param($stmt, \"issssi\", $product_id, $name, $email, $rating, $comment);\n            \n            if (mysqli_stmt_execute($stmt)) {\n                echo \"<div class='success'>Thank you for submitting your review!</div>\";\n            } else {\n                echo \"Error: \" . mysqli_error($conn);\n            }\n        }\n    }\n\n    // Display reviews\n    $query = \"SELECT * FROM reviews WHERE product_id = ? ORDER BY timestamp DESC\";\n    $stmt = mysqli_prepare($conn, $query);\n    mysqli_stmt_bind_param($stmt, \"i\", $product_id);\n    mysqli_stmt_execute($stmt);\n    $result = mysqli_stmt_get_result($stmt);\n\n    if (mysqli_num_rows($result) > 0) {\n        // Calculate average rating\n        $avg_query = \"SELECT AVG(rating) as avg_rating FROM reviews WHERE product_id = ?\";\n        $avg_stmt = mysqli_prepare($conn, $avg_query);\n        mysqli_stmt_bind_param($avg_stmt, \"i\", $product_id);\n        mysqli_stmt_execute($avg_stmt);\n        $avg_result = mysqli_stmt_get_result($avg_stmt);\n        $row = mysqli_fetch_assoc($avg_result);\n        $average_rating = number_format((float)$row['avg_rating'], 1, '.', '');\n\n        echo \"<h3>Customer Reviews</h3>\";\n        echo \"<p class='rating'>Average Rating: \" . $average_rating . \"/5 (\" . mysqli_num_rows($result) . \" reviews)</p>\";\n\n        // Display each review\n        while ($review = mysqli_fetch_assoc($result)) {\n            $stars_html = str_repeat(\"<span class='star'>\u2605</span>\", $review['rating']);\n            $date = date(\"d/m/Y H:i\", strtotime($review['timestamp']));\n            \n            echo \"<div class='review'>\";\n            echo \"<div class='review-header'>\";\n            echo \"<strong>\" . $review['user_name'] . \"</strong>\";\n            echo \"<span class='stars'>\" . $stars_html . \"</span>\";\n            echo \"<small>(\" . $date . \")</small>\";\n            echo \"</div>\";\n            echo \"<p class='comment'>\" . $review['comment'] . \"</p>\";\n            echo \"</div>\";\n        }\n    } else {\n        echo \"No reviews available for this product.\";\n    }\n\n    // Close database connection\n    mysqli_close($conn);\n}\n\n// Display review form\nfunction displayReviewForm() {\n    ?>\n    <form action=\"<?php $_SERVER['PHP_SELF']; ?>\" method=\"post\">\n        <div class=\"form-group\">\n            <label for=\"reviewer_name\">Name:</label>\n            <input type=\"text\" id=\"reviewer_name\" name=\"reviewer_name\" required>\n        </div>\n\n        <div class=\"form-group\">\n            <label for=\"reviewer_email\">Email:</label>\n            <input type=\"email\" id=\"reviewer_email\" name=\"reviewer_email\" required>\n        </div>\n\n        <div class=\"form-group\">\n            <label>Rating:</label><br>\n            <?php\n            // Display rating stars\n            for ($i = 1; $i <= 5; $i++) {\n                echo \"<input type='radio' name='rating' value='$i'>\u2605 \";\n            }\n            ?>\n        </div>\n\n        <div class=\"form-group\">\n            <label for=\"comment\">Review:</label>\n            <textarea id=\"comment\" name=\"comment\" rows=\"4\" required></textarea>\n        </div>\n\n        <button type=\"submit\" name=\"submit_review\">Submit Review</button>\n    </form>\n    <?php\n}\n\n// Usage example:\nif (isset($_GET['product_id'])) {\n    displayReviewForm();\n    handleReviews($_GET['product_id']);\n}\n?>\n```\n\nThis code provides:\n\n1. A form for users to submit reviews with:\n   - Name field\n   - Email field\n   - Rating stars (1-5)\n   - Comment textarea\n\n2. Review submission handling that:\n   - Validates inputs\n   - Stores reviews in a MySQL database\n   - Shows success/error messages\n\n3. Review display functionality that:\n   - Retrieves and displays stored reviews\n   - Calculates and shows average rating\n   - Formats the output with ratings, author names, timestamps, and comments\n\n4. Security measures including:\n   - Input sanitization\n   - Prepared statements to prevent SQL injection\n   - Required fields validation\n\nTo use this code:\n\n1. Replace database connection details (username, password, database_name)\n2. Create a reviews table in your database with the following columns:\n   - id (INT AUTO_INCREMENT PRIMARY KEY)\n   - product_id (INT)\n   - user_name (VARCHAR)\n   - user_email (VARCHAR)\n   - rating (TINYINT)\n   - comment (TEXT)\n   - timestamp (DATETIME)\n\n3. Include this code in your PHP script\n4. Call the functions with a specific product_id parameter\n\nThe reviews will be stored and displayed for each product, allowing users to see what others have said about the product.\n\nYou can customize the styling by adding CSS classes or modifying the HTML structure to match your website's design.", "code_blocks": ["```php\n<?php\n// Review submission and display function\nfunction handleReviews($product_id) {\n    // Database connection\n    $conn = mysqli_connect(\"localhost\", \"username\", \"password\", \"database_name\");\n    \n    if (!$conn) {\n        die(\"Connection failed: \" . mysqli_connect_error());\n    }\n\n    // Submit review\n    if (isset($_POST['submit_review'])) {\n        // Sanitize inputs\n        $name = mysqli_real_escape_string($conn, $_POST['reviewer_name']);\n        $email = mysqli_real_escape_string($conn, $_POST['reviewer_email']);\n        $rating = intval($_POST['rating']);\n        $comment = mysqli_real_escape_string($conn, $_POST['comment']);\n\n        // Validate inputs\n        if (empty($name) || empty($email) || empty($rating) || empty($comment)) {\n            echo \"Please fill in all fields.\";\n        } else {\n            // Insert review into database\n            $stmt = mysqli_prepare($conn, \"INSERT INTO reviews (product_id, user_name, user_email, rating, comment, timestamp) VALUES (?, ?, ?, ?, ?, CURRENT_TIMESTAMP)\");\n            mysqli_stmt_bind_param($stmt, \"issssi\", $product_id, $name, $email, $rating, $comment);\n            \n            if (mysqli_stmt_execute($stmt)) {\n                echo \"<div class='success'>Thank you for submitting your review!</div>\";\n            } else {\n                echo \"Error: \" . mysqli_error($conn);\n            }\n        }\n    }\n\n    // Display reviews\n    $query = \"SELECT * FROM reviews WHERE product_id = ? ORDER BY timestamp DESC\";\n    $stmt = mysqli_prepare($conn, $query);\n    mysqli_stmt_bind_param($stmt, \"i\", $product_id);\n    mysqli_stmt_execute($stmt);\n    $result = mysqli_stmt_get_result($stmt);\n\n    if (mysqli_num_rows($result) > 0) {\n        // Calculate average rating\n        $avg_query = \"SELECT AVG(rating) as avg_rating FROM reviews WHERE product_id = ?\";\n        $avg_stmt = mysqli_prepare($conn, $avg_query);\n        mysqli_stmt_bind_param($avg_stmt, \"i\", $product_id);\n        mysqli_stmt_execute($avg_stmt);\n        $avg_result = mysqli_stmt_get_result($avg_stmt);\n        $row = mysqli_fetch_assoc($avg_result);\n        $average_rating = number_format((float)$row['avg_rating'], 1, '.', '');\n\n        echo \"<h3>Customer Reviews</h3>\";\n        echo \"<p class='rating'>Average Rating: \" . $average_rating . \"/5 (\" . mysqli_num_rows($result) . \" reviews)</p>\";\n\n        // Display each review\n        while ($review = mysqli_fetch_assoc($result)) {\n            $stars_html = str_repeat(\"<span class='star'>\u2605</span>\", $review['rating']);\n            $date = date(\"d/m/Y H:i\", strtotime($review['timestamp']));\n            \n            echo \"<div class='review'>\";\n            echo \"<div class='review-header'>\";\n            echo \"<strong>\" . $review['user_name'] . \"</strong>\";\n            echo \"<span class='stars'>\" . $stars_html . \"</span>\";\n            echo \"<small>(\" . $date . \")</small>\";\n            echo \"</div>\";\n            echo \"<p class='comment'>\" . $review['comment'] . \"</p>\";\n            echo \"</div>\";\n        }\n    } else {\n        echo \"No reviews available for this product.\";\n    }\n\n    // Close database connection\n    mysqli_close($conn);\n}\n\n// Display review form\nfunction displayReviewForm() {\n    ?>\n    <form action=\"<?php $_SERVER['PHP_SELF']; ?>\" method=\"post\">\n        <div class=\"form-group\">\n            <label for=\"reviewer_name\">Name:</label>\n            <input type=\"text\" id=\"reviewer_name\" name=\"reviewer_name\" required>\n        </div>\n\n        <div class=\"form-group\">\n            <label for=\"reviewer_email\">Email:</label>\n            <input type=\"email\" id=\"reviewer_email\" name=\"reviewer_email\" required>\n        </div>\n\n        <div class=\"form-group\">\n            <label>Rating:</label><br>\n            <?php\n            // Display rating stars\n            for ($i = 1; $i <= 5; $i++) {\n                echo \"<input type='radio' name='rating' value='$i'>\u2605 \";\n            }\n            ?>\n        </div>\n\n        <div class=\"form-group\">\n            <label for=\"comment\">Review:</label>\n            <textarea id=\"comment\" name=\"comment\" rows=\"4\" required></textarea>\n        </div>\n\n        <button type=\"submit\" name=\"submit_review\">Submit Review</button>\n    </form>\n    <?php\n}\n\n// Usage example:\nif (isset($_GET['product_id'])) {\n    displayReviewForm();\n    handleReviews($_GET['product_id']);\n}\n?>\n```"]}
